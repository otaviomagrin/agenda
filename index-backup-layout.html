<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Tarefas</title>
    <style>
        /* Navy & Gold Theme - Paleta Clara */
        :root {
            --bg: #F7FAFC;
            --surface: #FFFFFF;
            --text: #0F172A;
            --text-muted: #475569;
            --primary: #0F3D91;
            --primary-contrast: #FFFFFF;
            --accent: #C28F2C;
            --accent-contrast: #0B1021;
            --border: #E2E8F0;
            --muted: #EEF2F6;
            --success: #16A34A;
            --warning: #F59E0B;
            --danger: #DC2626;
            --info: #2563EB;
            --radius: 12px;
            --space-1: 8px;
            --space-2: 12px;
            --space-3: 16px;
            --space-4: 24px;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Layout Enxuto - Topbar + Sidebar + Main */
        .app-layout {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* TOPBAR */
        .topbar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 var(--space-4);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 8px;
            border-radius: 6px;
        }

        .menu-btn:hover {
            background: var(--muted);
        }

        .app-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .topbar-center {
            flex: 1;
            max-width: 400px;
            margin: 0 var(--space-4);
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--muted);
            color: var(--text);
            font-size: 14px;
        }

        .search-input:focus {
            outline: 2px solid var(--primary);
            background: var(--surface);
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 14px;
            color: var(--text-muted);
        }

        .settings-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 8px;
            border-radius: 6px;
        }

        .settings-btn:hover {
            background: var(--muted);
        }

        /* MAIN LAYOUT */
        .main-layout {
            display: flex;
            margin-top: 60px;
            height: calc(100vh - 60px);
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: var(--space-4) 0;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 60px;
            height: calc(100vh - 60px);
        }

        .sidebar-nav {
            padding: 0 var(--space-3);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: 10px var(--space-2);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            color: var(--text-muted);
            font-size: 14px;
            text-decoration: none;
            transition: all 0.15s;
        }

        .nav-item:hover {
            background: var(--muted);
            color: var(--text);
        }

        .nav-item.active {
            background: var(--primary);
            color: var(--primary-contrast);
            border-left: 3px solid var(--accent);
        }

        /* Mini Calendário */
        .mini-calendar {
            padding: var(--space-3);
            margin-top: var(--space-4);
        }

        .mini-calendar h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--text);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            font-size: 12px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-muted);
            background: var(--surface);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .mini-calendar .calendar-day.header {
            background: var(--muted);
            font-weight: 600;
            color: var(--text-muted);
            cursor: default;
        }

        .mini-calendar .calendar-day.other-month {
            color: var(--text-muted);
            opacity: 0.4;
        }

        .mini-calendar .calendar-day.today {
            background: var(--primary);
            color: var(--primary-contrast);
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(15, 61, 145, 0.3);
        }

        .calendar-day:hover {
            background: var(--muted);
        }

        .calendar-day.today {
            background: var(--primary);
            color: var(--primary-contrast);
            font-weight: 600;
        }

        .calendar-day.has-tasks {
            background: var(--accent);
            color: var(--accent-contrast);
            position: relative;
        }

        .calendar-day.has-tasks::after {
            content: attr(data-events);
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: white;
            font-size: 9px;
            padding: 1px 3px;
            border-radius: 50%;
            min-width: 12px;
            text-align: center;
        }

        .calendar-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            white-space: nowrap;
            font-size: 11px;
            margin-top: 4px;
        }

        .calendar-day:hover .calendar-tooltip {
            display: block;
        }

        .calendar-day.selected {
            background: var(--primary);
            color: var(--primary-contrast);
            font-weight: 600;
        }

        /* Seção de Viagens */
        .travel-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space-3);
            margin: var(--space-3) 0;
        }

        .travel-location {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .country-flag {
            font-size: 24px;
        }

        .location-details h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text);
        }

        .location-details p {
            margin: 4px 0;
            font-size: 13px;
            color: var(--text-muted);
        }

        .travel-requirements {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-2);
            margin: var(--space-3) 0;
        }

        .requirement-card {
            background: var(--muted);
            padding: var(--space-2);
            border-radius: 6px;
        }

        .requirement-card h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .requirement-card p {
            margin: 0;
            font-size: 13px;
            color: var(--text);
            font-weight: 500;
        }

        .currency-info {
            background: var(--muted);
            padding: var(--space-2);
            border-radius: 6px;
            margin: var(--space-2) 0;
        }

        .currency-info .rate {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .language-phrases {
            margin-top: var(--space-3);
        }

        .phrase-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .phrase-item:last-child {
            border-bottom: none;
        }

        .phrase-original {
            font-weight: 500;
            color: var(--text);
        }

        .phrase-translation {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Filtros e Tags */
        .sidebar-section {
            padding: var(--space-3);
            margin-top: var(--space-4);
            border-top: 1px solid var(--border);
        }

        .sidebar-section h3 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: var(--space-2);
            letter-spacing: 0.5px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            margin-bottom: var(--space-1);
            font-size: 12px;
        }

        .filter-checkbox {
            margin-right: var(--space-1);
        }

        .tag-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .tag-chip {
            background: var(--muted);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            border: none;
        }

        .tag-chip:hover {
            background: var(--primary);
            color: var(--primary-contrast);
        }

        /* Rodapé Sidebar */
        .sidebar-footer {
            padding: var(--space-3);
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        .weekly-progress {
            font-size: 12px;
            color: var(--text-muted);
        }

        .progress-bar {
            height: 4px;
            background: var(--muted);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        /* CONTEÚDO PRINCIPAL */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: var(--space-4);
            overflow-y: auto;
        }

        /* PROJECT CARDS */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-3);
        }

        .project-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--space-4);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(15, 61, 145, 0.1);
        }

        .project-card.status-good {
            border-left: 4px solid var(--success);
        }

        .project-card.status-warning {
            border-left: 4px solid var(--warning);
        }

        .project-card.status-danger {
            border-left: 4px solid var(--danger);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .project-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            flex: 1;
        }

        .project-progress {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .progress-bar {
            width: 80px;
            height: 6px;
            background: var(--muted);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .project-body {
            margin-bottom: var(--space-3);
        }

        .project-description {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
            margin: 0 0 var(--space-3) 0;
        }

        .project-meta {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .deadline-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .deadline-label {
            color: var(--text-muted);
        }

        .deadline-date {
            font-weight: 500;
            color: var(--text);
        }

        .days-remaining {
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--muted);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 500;
        }

        .days-remaining.urgent {
            background: var(--danger);
            color: white;
        }

        .project-stats {
            display: flex;
            gap: var(--space-3);
        }

        .stat {
            font-size: 13px;
            color: var(--text-muted);
        }

        .project-actions {
            display: flex;
            gap: var(--space-2);
            padding-top: var(--space-3);
            border-top: 1px solid var(--border);
        }

        .btn-primary, .btn-secondary {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--primary-contrast);
        }

        .btn-primary:hover {
            background: #0a2d6b;
        }

        .btn-secondary {
            background: var(--muted);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #dde4ea;
        }

        /* TASK QUICK ITEMS */
        .task-quick {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            margin-bottom: 8px;
            background: var(--surface);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .task-type-icon {
            font-size: 16px;
        }

        .task-title {
            flex: 1;
            font-weight: 500;
            color: var(--text);
        }

        .task-time {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* KANBAN DRAWER */
        .kanban-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .kanban-drawer.open {
            visibility: visible;
            opacity: 1;
        }

        .drawer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }

        .drawer-content {
            position: absolute;
            top: 0;
            right: 0;
            width: 80%;
            max-width: 1200px;
            height: 100%;
            background: var(--bg);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .kanban-drawer.open .drawer-content {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .drawer-header h2 {
            margin: 0;
            color: var(--text);
            font-size: 20px;
            font-weight: 600;
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .drawer-close:hover {
            background: var(--muted);
            color: var(--text);
        }

        .kanban-board {
            flex: 1;
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4);
            overflow-x: auto;
            overflow-y: hidden;
        }

        .kanban-column {
            flex: 0 0 280px;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            max-height: calc(100vh - 120px);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            border-bottom: 1px solid var(--border);
            background: var(--muted);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .column-title {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .task-count {
            background: var(--primary);
            color: var(--primary-contrast);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .column-content {
            flex: 1;
            padding: var(--space-2);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .kanban-task {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: var(--space-2);
            cursor: grab;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .kanban-task:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .kanban-task.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .kanban-task-title {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 4px;
            font-size: 14px;
        }

        .kanban-task-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .task-type-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .task-type-badge.tarefa {
            background: var(--info);
            color: white;
        }

        .task-type-badge.marco {
            background: var(--warning);
            color: white;
        }

        .task-type-badge.repetitiva {
            background: var(--success);
            color: white;
        }

        .add-task-btn {
            margin: var(--space-2);
            padding: var(--space-2);
            background: none;
            border: 2px dashed var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .add-task-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--muted);
        }

        .column-content.drag-over {
            background: var(--muted);
            border: 2px dashed var(--primary);
        }

        /* Tabs */
        .content-tabs {
            display: flex;
            gap: 0;
            margin-bottom: var(--space-4);
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 14px;
            transition: all 0.15s;
        }

        .tab-btn:hover {
            color: var(--text);
            background: var(--muted);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Cards de Projeto */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--space-3);
        }

        .project-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space-3);
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .project-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        /* Elementos auxiliares */
        .btn-primary {
            background: var(--primary);
            color: var(--primary-contrast);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-rag.verde { background: var(--success); color: white; }
        .badge-rag.amarelo { background: var(--warning); color: var(--text); }
        .badge-rag.vermelho { background: var(--danger); color: white; }

        .container {
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: white;
            color: #667eea;
        }
        
        .view-container {
            display: none;
        }
        
        .view-container.active {
            display: block;
        }
        
        .content {
            background: transparent;
            color: #333;
            padding: 30px;
        }

        /* Tab Content - Sistema de navegação unificado */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block !important;
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        /* Views de Tasks e Projects com fundo branco */
        .tasks-view .content,
        .projects-view .content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* Quick Add */
        .quick-add-card {
            margin-bottom: var(--space-4);
        }

        .quick-add-container {
            display: flex;
            gap: var(--space-2);
        }

        .quick-add-input {
            flex: 1;
            padding: var(--space-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
        }

        .quick-add-btn {
            background: var(--primary);
            color: var(--primary-contrast);
            border: none;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 16px;
        }

        .quick-add-btn:hover {
            background: #0d3780;
        }

        /* Dashboard 60 Dias */
        .dashboard-60days {
            padding: var(--space-4);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--border);
        }

        .dashboard-header h2 {
            margin: 0;
            color: var(--text);
            font-size: 24px;
        }

        .period-info {
            font-size: 14px;
            color: var(--text-muted);
            background: var(--muted);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .dashboard-summary {
            display: grid;
            gap: var(--space-4);
        }

        .summary-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space-4);
        }

        .summary-card h3 {
            margin: 0 0 var(--space-3) 0;
            font-size: 18px;
            color: var(--text);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-3);
        }

        .metric-item {
            text-align: center;
            padding: var(--space-3);
            background: var(--muted);
            border-radius: 8px;
        }

        .metric-value {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .metric-label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .timeline-60days {
            max-height: 400px;
            overflow-y: auto;
        }

        .timeline-60days-item {
            display: flex;
            align-items: center;
            padding: var(--space-2);
            border-left: 3px solid var(--border);
            margin-left: 20px;
            padding-left: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .timeline-60days-item.flight {
            border-left-color: var(--info);
        }

        .timeline-60days-item.travel {
            border-left-color: var(--success);
        }

        .timeline-60days-item.deadline {
            border-left-color: var(--danger);
        }

        .timeline-60days-date {
            font-weight: 600;
            color: var(--primary);
            min-width: 100px;
        }

        .timeline-60days-content {
            flex: 1;
            margin-left: var(--space-3);
        }

        .projects-deadline {
            display: grid;
            gap: var(--space-2);
        }

        .project-deadline-item {
            padding: var(--space-2);
            background: var(--muted);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-deadline-name {
            font-weight: 500;
            color: var(--text);
        }

        .project-deadline-date {
            font-size: 13px;
            color: var(--text-muted);
        }

        .travel-schedule-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--muted);
            border-radius: 8px;
            margin-bottom: var(--space-2);
        }

        .travel-flag {
            font-size: 32px;
        }

        .travel-details {
            flex: 1;
        }

        .travel-destination {
            font-weight: 600;
            color: var(--text);
        }

        .travel-dates {
            font-size: 13px;
            color: var(--text-muted);
        }

        .workload-chart {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 4px;
        }

        .workload-bar {
            flex: 1;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 10px;
            transition: all 0.3s ease;
        }

        .workload-bar:hover {
            background: var(--accent);
        }

        .workload-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Dashboard Widgets */
        .dashboard-widgets {
            margin-bottom: var(--space-4);
        }

        .widget-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .widget {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space-4);
        }

        .widget h4 {
            margin: 0 0 var(--space-3) 0;
            font-size: 16px;
            color: var(--text);
        }

        /* Stats Widget */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .stat-item {
            text-align: center;
            padding: var(--space-2);
            background: var(--muted);
            border-radius: 8px;
        }

        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .progress-widget {
            margin-top: var(--space-3);
        }

        .progress-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .progress-bar-widget {
            width: 100%;
            height: 12px;
            background: var(--muted);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill-widget {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            border-radius: 6px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-top: 8px;
        }

        /* Timer Widget */
        .timer-container {
            text-align: center;
        }

        .timer-display {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
            margin-bottom: var(--space-3);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .timer-btn {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .timer-btn:hover {
            background: var(--muted);
            transform: scale(1.05);
        }

        .timer-btn.start {
            border-color: var(--success);
            color: var(--success);
        }

        .timer-btn.pause {
            border-color: var(--warning);
            color: var(--warning);
        }

        .timer-btn.reset {
            border-color: var(--danger);
            color: var(--danger);
        }

        .timer-mode {
            display: flex;
            gap: var(--space-1);
            justify-content: center;
        }

        .mode-btn {
            background: var(--muted);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: var(--primary);
            color: var(--primary-contrast);
            border-color: var(--primary);
        }

        /* Timeline */
        .timeline-container {
            position: relative;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: var(--space-2) 0;
            border-left: 3px solid var(--border);
            margin-left: 20px;
            padding-left: var(--space-3);
            position: relative;
        }

        .timeline-item:before {
            content: '';
            position: absolute;
            left: -7px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            border: 2px solid var(--surface);
        }

        .timeline-time {
            font-weight: 600;
            color: var(--primary);
            font-family: monospace;
            min-width: 60px;
            margin-right: var(--space-2);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }

        .timeline-type {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--muted);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        /* Enhanced Tasks */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .task-filters {
            display: flex;
            gap: var(--space-1);
        }

        .filter-btn {
            background: var(--muted);
            border: 1px solid var(--border);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: var(--primary);
            color: var(--primary-contrast);
            border-color: var(--primary);
        }

        .tasks-enhanced .task-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: var(--space-2);
            transition: all 0.2s ease;
        }

        .tasks-enhanced .task-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .task-checkbox {
            margin-right: var(--space-2);
            cursor: pointer;
        }

        .task-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: var(--space-2);
        }

        .task-priority.high { background: var(--danger); }
        .task-priority.medium { background: var(--warning); }
        .task-priority.low { background: var(--success); }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }

        .task-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .task-actions {
            display: flex;
            gap: var(--space-1);
        }

        .task-action-btn {
            background: none;
            border: 1px solid var(--border);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .task-action-btn:hover {
            background: var(--muted);
        }

        /* Meetings */
        .meeting-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: var(--space-2);
        }

        .meeting-time {
            font-weight: 600;
            color: var(--primary);
            font-family: monospace;
            min-width: 80px;
            margin-right: var(--space-3);
        }

        .meeting-content {
            flex: 1;
        }

        .meeting-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .meeting-details {
            font-size: 12px;
            color: var(--text-muted);
        }

        .meeting-actions {
            display: flex;
            gap: var(--space-1);
        }

        .meeting-action-btn {
            background: none;
            border: 1px solid var(--border);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-btn {
            background: var(--accent);
            color: var(--accent-contrast);
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .add-btn:hover {
            background: #b8821f;
        }

        /* Completed tasks styling */
        .task-title.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .widget-row {
                grid-template-columns: 1fr;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .timer-display {
                font-size: 36px;
            }

            .task-actions {
                flex-direction: column;
            }

            .meeting-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .meeting-time {
                margin-bottom: var(--space-2);
            }
        }

        /* Loading states */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Animation for new items */
        .task-item, .meeting-item {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Better focus styles */
        .quick-add-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(15, 61, 145, 0.2);
        }

        /* Current time indicator in timeline */
        .timeline-item.current-time:before {
            background: var(--warning);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Backup Interface Styles */
        .backup-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .backup-status-card,
        .version-card,
        .data-backup-card,
        .version-history-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space-4);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 2px solid var(--border);
        }

        .backup-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-3);
        }

        .status-widget {
            background: var(--muted);
            border-radius: 8px;
            padding: var(--space-3);
            text-align: center;
        }

        .status-widget h4 {
            color: var(--primary);
            margin-bottom: var(--space-2);
            font-size: 14px;
        }

        .status-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: var(--space-1);
        }

        .status-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .version-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-3);
        }

        .version-detail {
            background: var(--muted);
            border-radius: 8px;
            padding: var(--space-3);
        }

        .version-detail h5 {
            color: var(--primary);
            margin-bottom: var(--space-1);
            font-size: 14px;
        }

        .version-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .version-stage {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .version-stage.alpha {
            background: var(--danger);
            color: white;
        }

        .version-stage.beta {
            background: var(--warning);
            color: white;
        }

        .version-stage.stable {
            background: var(--success);
            color: white;
        }

        .action-btn {
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .action-btn.primary {
            background: var(--primary);
            color: var(--primary-contrast);
        }

        .action-btn.success {
            background: var(--success);
            color: white;
        }

        .action-btn.warning {
            background: var(--warning);
            color: white;
        }

        .action-btn.info {
            background: var(--info);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .refresh-btn {
            background: var(--muted);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
        }

        .backup-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: var(--space-2);
            background: var(--surface);
        }

        .backup-item:hover {
            background: var(--muted);
        }

        .backup-info {
            flex: 1;
        }

        .backup-label {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .backup-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .backup-actions {
            display: flex;
            gap: var(--space-1);
        }

        .backup-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .backup-btn:hover {
            background: var(--primary);
            color: var(--primary-contrast);
            border-color: var(--primary);
        }

        .version-timeline {
            max-height: 500px;
            overflow-y: auto;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            border-left: 3px solid var(--border);
            margin-left: 20px;
            padding-left: var(--space-3);
            position: relative;
            margin-bottom: var(--space-2);
        }

        .timeline-item:before {
            content: '';
            position: absolute;
            left: -7px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            border: 2px solid var(--surface);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-version {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .timeline-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .backup-status-grid {
                grid-template-columns: 1fr;
            }

            .version-info {
                grid-template-columns: 1fr;
            }

            .backup-item {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-2);
            }
        }

        /* Calendário */
        .calendar-section {
            margin-bottom: 30px;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .calendar-nav button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .calendar-nav button:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }
        
        .month-year {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 15px;
        }
        
        .calendar-header {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .calendar-day {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 45px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #e2e8f0;
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .calendar-day.today {
            background: #667eea;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
            color: #999;
        }
        
        .calendar-day.has-tasks::after {
            content: '';
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ff6b6b;
            opacity: 1;
        }

        .calendar-day.has-meetings::after {
            background: #4ecdc4;
        }

        .calendar-day.has-tasks.has-meetings::after {
            background: linear-gradient(45deg, #ff6b6b 50%, #4ecdc4 50%);
        }
        
        /* Tarefas */
        .tasks-section {
            margin-top: 20px;
        }
        
        .task-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }
        
        .task-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .task-info h3 {
            color: #333;
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }
        
        .task-info p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
        }
        
        .task-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .complete-btn {
            background: #4ecdc4;
            color: white;
        }
        
        .delete-btn {
            background: #ff6b6b;
            color: white;
        }
        
        /* Formulários */
        .form-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .test-area {
            margin-top: 30px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 10px;
            border-left: 4px solid #4ecdc4;
        }

        /* Dashboard layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .dashboard-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dashboard-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3rem;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* Diferentes cores de borda para cada seção */
        .dashboard-section:nth-child(1) {
            border-left-color: #4ecdc4;
        }

        .dashboard-section:nth-child(2) {
            border-left-color: #667eea;
        }

        /* Estilos para tarefas de projeto */
        .project-tasks-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e3e8ff;
        }

        .project-tasks-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #4c6ef5;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .project-task-form .form-row {
            gap: 10px;
            align-items: center;
        }

        .btn-small {
            padding: 8px 16px;
            background: linear-gradient(45deg, #4c6ef5, #6c5ce7);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-small:hover {
            background: linear-gradient(45deg, #364fc7, #5f3dc4);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 111, 245, 0.3);
        }

        .project-tasks-list {
            margin-top: 15px;
        }

        .project-task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .project-task-item.completed {
            text-decoration: line-through;
            opacity: 0.7;
            background: #f8f9fa;
        }

        .project-task-item.overdue {
            border-left: 4px solid #e63946;
            background: #fff5f5;
        }

        .project-task-date {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: 10px;
        }

        .project-task-actions {
            display: flex;
            gap: 5px;
        }

        .btn-tiny {
            padding: 4px 8px;
            font-size: 0.7rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-complete {
            background: #51cf66;
            color: white;
        }

        .btn-complete:hover {
            background: #40c057;
        }

        .btn-remove {
            background: #ff6b6b;
            color: white;
        }

        .btn-remove:hover {
            background: #fa5252;
        }

        .project-progress-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #51cf66, #40c057);
            transition: width 0.3s ease;
        }

        .overdue-indicator {
            background: #e63946;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Novos estilos para indicadores de projeto */
        .project-indicators {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .progress-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .burndown-section, .milestones-section {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .burndown-label, .milestones-label {
            font-weight: 600;
            color: #495057;
        }

        .completed-tasks, .milestones-count {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #495057;
        }

        .milestone {
            display: inline-block;
            font-size: 0.8rem;
        }

        .milestone.completed {
            opacity: 1;
        }

        .milestone.pending {
            opacity: 0.6;
        }

        /* Estilos para dependências e tarefas bloqueadas */
        .project-task-item.blocked {
            background: #f8f9fa;
            border-left: 4px solid #adb5bd;
        }

        .dependency-info {
            display: block;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .blocked-indicator {
            display: inline-block;
            background: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover,
        .close:focus {
            color: #667eea;
            text-decoration: none;
        }

        .project-item:hover {
            background: #f8f9fa;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        /* RAG Status Styles */
        .rag-status {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .rag-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }

        .rag-indicator.active {
            opacity: 1;
        }

        .rag-indicator.verde {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .rag-indicator.amarelo {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .rag-indicator.vermelho {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .rag-indicator:hover {
            opacity: 0.8;
        }

        /* Task Status Styles */
        .task-main-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .task-title-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-type-icon {
            font-size: 14px;
            width: 20px;
            text-align: center;
        }

        .task-title {
            flex: 1;
            font-weight: 500;
        }

        .task-status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .task-status-badge.a-fazer {
            background: #e9ecef;
            color: #495057;
        }

        .task-status-badge.fazendo {
            background: #fff3cd;
            color: #856404;
        }

        .task-status-badge.bloqueada {
            background: #f8d7da;
            color: #721c24;
        }

        .task-status-badge.concluída {
            background: #d4edda;
            color: #155724;
        }

        .task-status-badge.adiada {
            background: #d1ecf1;
            color: #0c5460;
        }

        .task-note {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }

        .btn-status {
            background: #28a745;
            color: white;
        }

        .btn-status:hover {
            background: #218838;
        }

        .btn-status:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Reports Styles */
        .report-content {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .report-placeholder {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .report-section {
            margin-bottom: 30px;
            padding: 20px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
        }

        .report-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .report-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .project-summary {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }

        .project-summary.warning {
            border-left-color: #f39c12;
        }

        .project-summary.danger {
            border-left-color: #e74c3c;
        }

        .task-breakdown {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .task-type-count {
            background: #ecf0f1;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
        }

        .export-options {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* Tarefas Recorrentes */
        .recurring-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .recurring-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .recurring-item.inactive {
            opacity: 0.6;
            border-left: 4px solid var(--warning);
        }

        .recurring-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .recurring-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--text);
        }

        .recurring-next {
            font-size: 14px;
            color: var(--text-muted);
        }

        .recurring-status {
            font-size: 12px;
            font-style: italic;
            color: var(--warning);
        }

        .recurring-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .recurring-item .btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- TOPBAR -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="menu-btn">☰</button>
                <h1 class="app-title">Agenda Pessoal</h1>
            </div>
            
            <div class="topbar-center">
                <input type="text" class="search-input" placeholder="Pesquisar...">
            </div>
            
            <div class="topbar-right">
                <span id="current-date-time" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 13px; color: var(--text-muted);">📅</span>
                    <strong id="current-date" style="font-size: 13px;">Carregando...</strong>
                    <span style="color: var(--border);">|</span>
                    <span style="font-size: 13px; color: var(--text-muted);">🕐</span>
                    <span id="current-time" style="font-size: 13px; font-weight: 600; font-family: monospace;">--:--:--</span>
                </span>
                <button class="settings-btn">⚙</button>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <div class="main-layout">
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <a href="#" class="nav-item active" data-tab="dashboard">
                        <span>📊</span> Dashboard
                    </a>
                    <a href="#" class="nav-item" data-tab="hoje">
                        <span>📋</span> Hoje
                    </a>
                    <a href="#" class="nav-item" data-tab="calendario">
                        <span>📅</span> Calendário
                    </a>
                    <a href="#" class="nav-item" data-tab="projetos">
                        <span>📁</span> Projetos
                    </a>
                    <a href="#" class="nav-item" data-tab="tarefas">
                        <span>✓</span> Tarefas
                    </a>
                    <a href="#" class="nav-item" data-tab="recorrentes">
                        <span>🔄</span> Recorrentes
                    </a>
                    <a href="#" class="nav-item" data-tab="relatorios">
                        <span>📈</span> Relatórios
                    </a>
                    <a href="#" class="nav-item" data-tab="preferencias">
                        <span>⚙</span> Preferências
                    </a>
                    <a href="#" class="nav-item" data-tab="projeto" onclick="openProjectView()">
                        <span>📈</span> Projeto
                    </a>
                    <a href="#" class="nav-item" data-tab="backup">
                        <span>💾</span> Backup
                    </a>
                </nav>

                <!-- Mini Calendário -->
                <div class="mini-calendar">
                    <h3 id="mini-calendar-title">Carregando...</h3>
                    <div class="calendar-grid" id="mini-calendar-grid">
                        <!-- Gerado dinamicamente via JavaScript -->
                    </div>
                </div>

                <!-- Filtros Rápidos -->
                <div class="sidebar-section">
                    <h3>Filtros Rápidos</h3>
                    <div class="filter-item">
                        <input type="checkbox" class="filter-checkbox" id="filter-pessoais" checked>
                        <label for="filter-pessoais">pessoais</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" class="filter-checkbox" id="filter-trabalho" checked>
                        <label for="filter-trabalho">trabalho</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" class="filter-checkbox" id="filter-estudo">
                        <label for="filter-estudo">estudo</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" class="filter-checkbox" id="filter-saude">
                        <label for="filter-saude">saúde</label>
                    </div>
                </div>

                <!-- Tags -->
                <div class="sidebar-section">
                    <h3>Tags</h3>
                    <div class="tag-chips">
                        <button class="tag-chip">#pessoal</button>
                        <button class="tag-chip">#trabalho</button>
                        <button class="tag-chip">#estudo</button>
                        <button class="tag-chip">#saúde</button>
                    </div>
                </div>

                <!-- Rodapé: Progresso semanal -->
                <div class="sidebar-footer">
                    <div class="weekly-progress">
                        <div>Progresso semanal: <strong>12/15</strong></div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 80%;"></div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- CONTEÚDO PRINCIPAL -->
            <main class="main-content">
                <!-- Dashboard View (aba Dashboard da sidebar) -->
                <div id="content-dashboard" class="tab-content active" style="display: block;">
                    <!-- Dashboard - Visão de 60 Dias -->
                    <div class="dashboard-60days">
                        <div class="dashboard-header">
                            <h2>📅 Visão Geral - Próximos 60 Dias</h2>
                            <div class="period-info">
                                <span id="period-range"></span>
                            </div>
                        </div>

                        <!-- Resumo Geral dos 60 dias -->
                        <div class="dashboard-summary">
                            <div class="summary-card">
                                <h3>📊 Métricas Gerais</h3>
                                <div class="metrics-grid">
                                    <div class="metric-item">
                                        <span class="metric-value" id="total-events-60">0</span>
                                        <span class="metric-label">Total de Eventos</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-value" id="total-meetings-60">0</span>
                                        <span class="metric-label">Reuniões</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-value" id="total-tasks-60">0</span>
                                        <span class="metric-label">Tarefas</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-value" id="total-flights-60">0</span>
                                        <span class="metric-label">✈️ Voos</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-value" id="total-travels-60">0</span>
                                        <span class="metric-label">🌍 Viagens</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-value" id="projects-active-60">0</span>
                                        <span class="metric-label">Projetos Ativos</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Timeline dos Próximos 60 Dias -->
                            <div class="summary-card">
                                <h3>📅 Eventos Importantes</h3>
                                <div class="timeline-60days" id="timeline-60days">
                                    <!-- Será preenchido via JS -->
                                </div>
                            </div>

                            <!-- Projetos com Deadline nos Próximos 60 Dias -->
                            <div class="summary-card">
                                <h3>🎯 Projetos com Prazo</h3>
                                <div class="projects-deadline" id="projects-deadline-60">
                                    <!-- Será preenchido via JS -->
                                </div>
                            </div>

                            <!-- Viagens Programadas -->
                            <div class="summary-card">
                                <h3>✈️ Viagens Programadas</h3>
                                <div class="travel-schedule" id="travel-schedule-60">
                                    <!-- Será preenchido via JS -->
                                </div>
                            </div>

                            <!-- Distribuição de Carga de Trabalho -->
                            <div class="summary-card">
                                <h3>📈 Distribuição de Carga</h3>
                                <div class="workload-chart" id="workload-chart-60">
                                    <!-- Será preenchido via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="content-hoje" class="tab-content" style="display: none;">
                    <!-- Quick Add -->
                    <div class="card quick-add-card">
                        <h3>⚡ Adicionar Rápido</h3>
                        <div class="quick-add-container">
                            <input type="text" id="quick-add-input" placeholder="Ex: Reunir com equipe amanhã às 14h" class="quick-add-input">
                            <button id="quick-add-btn" class="quick-add-btn">➕</button>
                        </div>
                    </div>

                            <div class="widget timer-widget">
                                <h4>⏱️ Foco & Produtividade</h4>
                                <div class="timer-container">
                                    <div class="timer-display" id="timer-display">25:00</div>
                                    <div class="timer-controls">
                                        <button id="timer-start" class="timer-btn start">▶️</button>
                                        <button id="timer-pause" class="timer-btn pause">⏸️</button>
                                        <button id="timer-reset" class="timer-btn reset">🔄</button>
                                    </div>
                                    <div class="timer-mode">
                                        <button id="pomodoro-mode" class="mode-btn active">Pomodoro</button>
                                        <button id="break-mode" class="mode-btn">Pausa</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informações de Viagem (se aplicável) -->
                    <div id="travel-info-section" class="travel-info" style="display: none;">
                        <div class="travel-location">
                            <span class="country-flag" id="country-flag">🇧🇷</span>
                            <div class="location-details">
                                <h4 id="location-name">Brasil - São Paulo</h4>
                                <p id="location-date">Sem viagem programada</p>
                            </div>
                        </div>

                        <div class="travel-requirements">
                            <div class="requirement-card">
                                <h5>Visto</h5>
                                <p id="visa-status">Não necessário</p>
                            </div>
                            <div class="requirement-card">
                                <h5>Vacinas</h5>
                                <p id="vaccine-status">Nenhuma obrigatória</p>
                            </div>
                        </div>

                        <div class="currency-info">
                            <h5>Moeda Local</h5>
                            <p><span id="currency-name">Real (BRL)</span></p>
                            <p class="rate">1 <span id="currency-code">USD</span> = R$ <span id="exchange-rate">5.20</span></p>
                        </div>

                        <div class="language-phrases">
                            <h5>Frases Úteis em <span id="language-name">Português</span></h5>
                            <div id="useful-phrases">
                                <div class="phrase-item">
                                    <span class="phrase-original">Olá</span>
                                    <span class="phrase-translation">Hello</span>
                                </div>
                                <div class="phrase-item">
                                    <span class="phrase-original">Por favor</span>
                                    <span class="phrase-translation">Please</span>
                                </div>
                                <div class="phrase-item">
                                    <span class="phrase-original">Obrigado</span>
                                    <span class="phrase-translation">Thank you</span>
                                </div>
                                <div class="phrase-item">
                                    <span class="phrase-original">Onde fica...?</span>
                                    <span class="phrase-translation">Where is...?</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline do Dia -->
                    <div class="card timeline-card">
                        <h3>🕰️ Timeline do Dia</h3>
                        <div class="timeline-container" id="timeline-container">
                            <!-- Timeline será gerada via JS -->
                        </div>
                    </div>

                    <!-- Resumo do Dia -->
                    <div class="card">
                        <h3>📊 Resumo do Dia</h3>
                        <div class="day-summary" id="day-summary">
                            <p style="color: var(--text-muted);">Carregando eventos...</p>
                        </div>
                    </div>

                    <!-- Próximas Ações Melhoradas -->
                    <div class="card">
                        <div class="card-header">
                            <h2>📋 Próximas Ações</h2>
                            <div class="task-filters">
                                <button class="filter-btn active" data-filter="all">Todas</button>
                                <button class="filter-btn" data-filter="high">Alta</button>
                                <button class="filter-btn" data-filter="medium">Média</button>
                                <button class="filter-btn" data-filter="low">Baixa</button>
                            </div>
                        </div>
                        <div id="proximas-acoes" class="tasks-enhanced">
                            <!-- Carregado via JS -->
                        </div>
                    </div>

                    <!-- Reuniões do Dia -->
                    <div class="card">
                        <div class="card-header">
                            <h2>📅 Reuniões do Dia</h2>
                            <button id="add-meeting-btn" class="add-btn">➕ Nova Reunião</button>
                        </div>
                        <div id="reunioes-hoje" class="meetings-container">
                            <!-- Carregado via JS -->
                        </div>
                    </div>
                </div>

                <div id="content-calendario" class="tab-content" style="display: none;">
                    <div class="card">
                        <h2>📅 Calendário</h2>
                        <div id="calendario-main">
                            <div class="calendar-section">
                                <div class="calendar-nav">
                                    <button id="prev-month" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">❮ Anterior</button>
                                    <h3 id="current-month" style="margin: 0; font-size: 18px; color: var(--text);">Carregando...</h3>
                                    <button id="next-month" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Próximo ❯</button>
                                </div>
                                <div id="calendar-grid" class="calendar-grid">
                                    <!-- Cabeçalhos dos dias -->
                                    <div class="calendar-header">Dom</div>
                                    <div class="calendar-header">Seg</div>
                                    <div class="calendar-header">Ter</div>
                                    <div class="calendar-header">Qua</div>
                                    <div class="calendar-header">Qui</div>
                                    <div class="calendar-header">Sex</div>
                                    <div class="calendar-header">Sáb</div>
                                    <!-- Dias serão adicionados aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="content-projetos" class="tab-content" style="display: none;">
                    <div class="project-grid" id="projects-grid">
                        <!-- Cards de projeto serão gerados aqui -->
                    </div>
                </div>

                <!-- Aba Tarefas -->
                <div id="content-tarefas" class="tab-content" style="display: none;">
                    <div class="container">
                        <h2>✓ Tarefas</h2>
                        
                        <!-- Barra de Busca Avançada -->
                        <div class="advanced-search" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="search-input" placeholder="🔍 Buscar tarefas..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <button onclick="searchTasks()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Buscar</button>
                                <button onclick="toggleAdvancedFilters()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">⚙ Filtros</button>
                            </div>
                            
                            <div id="advanced-filters" style="display: none; padding-top: 10px; border-top: 1px solid #ddd;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                    <select id="filter-category" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="">Todas as categorias</option>
                                        <option value="pessoal">Pessoal</option>
                                        <option value="trabalho">Trabalho</option>
                                        <option value="saude">Saúde</option>
                                        <option value="financas">Finanças</option>
                                        <option value="voo">✈️ Voo</option>
                                        <option value="viagem">🌍 Viagem</option>
                                    </select>
                                    <select id="filter-priority" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="">Todas as prioridades</option>
                                        <option value="alta">Alta</option>
                                        <option value="media">Média</option>
                                        <option value="baixa">Baixa</option>
                                    </select>
                                    <select id="filter-date-range" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="">Todos os períodos</option>
                                        <option value="today">Hoje</option>
                                        <option value="week">Esta semana</option>
                                        <option value="month">Este mês</option>
                                        <option value="overdue">Atrasadas</option>
                                    </select>
                                    <select id="filter-recurrent" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="">Todas</option>
                                        <option value="recurrent">Recorrentes</option>
                                        <option value="single">Únicas</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button onclick="openRecurrentTaskModal()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                🔄 Nova Tarefa Recorrente
                            </button>
                            <button onclick="openTaskModal()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                ➕ Nova Tarefa
                            </button>
                        </div>
                        
                        <div class="task-filters" style="margin: 20px 0;">
                            <button class="filter-btn active" data-filter="all">Todas</button>
                            <button class="filter-btn" data-filter="pending">Pendentes</button>
                            <button class="filter-btn" data-filter="completed">Concluídas</button>
                            <button class="filter-btn" data-filter="overdue">Atrasadas</button>
                            <button class="filter-btn" data-filter="recurrent">Recorrentes</button>
                        </div>
                        <div id="tasks-list">
                            <!-- Lista de tarefas será carregada aqui -->
                        </div>
                    </div>
                </div>

                <!-- Aba Recorrentes -->
                <div id="content-recorrentes" class="tab-content" style="display: none;">
                    <div class="container">
                        <h2>🔄 Tarefas Recorrentes</h2>
                        <p>Gerencie suas séries de tarefas recorrentes</p>
                        
                        <!-- Botões de Ação -->
                        <div style="display: flex; gap: 10px; margin: 20px 0;">
                            <button onclick="openRecurringModal()" style="padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ➕ Nova Série Recorrente
                            </button>
                            <button onclick="loadRecurringTasks()" style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                🔄 Atualizar
                            </button>
                        </div>

                        <!-- Estatísticas Rápidas -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #27ae60;" id="stats-active">-</div>
                                <div style="color: #2c5c2c;">Séries Ativas</div>
                            </div>
                            <div style="background: #fef9e7; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #f39c12;" id="stats-paused">-</div>
                                <div style="color: #8b6914;">Séries Pausadas</div>
                            </div>
                            <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #3498db;" id="stats-next">-</div>
                                <div style="color: #2c5aa0;">Próximas 24h</div>
                            </div>
                        </div>

                        <!-- Lista de Séries Recorrentes -->
                        <div id="recurring-tasks-list" style="margin-top: 20px;">
                            <div class="empty-state" style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 16px;">📅</div>
                                <p>Nenhuma série recorrente encontrada</p>
                                <p style="font-size: 14px; color: #999;">Clique em "Nova Série Recorrente" para começar</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Relatórios -->
                <div id="content-relatorios" class="tab-content" style="display: none;">
                    <div class="container">
                        <h2>📈 Relatórios</h2>
                        <div class="report-options" style="margin: 20px 0;">
                            <select id="report-type" style="padding: 10px; margin-right: 10px;">
                                <option value="summary">Resumo Geral</option>
                                <option value="projects">Relatório de Projetos</option>
                                <option value="productivity">Produtividade</option>
                                <option value="weekly">Relatório Semanal</option>
                            </select>
                            <button onclick="generateReport()" style="padding: 10px 20px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer;">Gerar Relatório</button>
                        </div>
                        <div id="report-content">
                            <!-- Conteúdo do relatório será exibido aqui -->
                        </div>
                    </div>
                </div>

                <!-- Aba Preferências -->
                <div id="content-preferencias" class="tab-content" style="display: none;">
                    <div class="container">
                        <h2>⚙ Preferências</h2>
                        <div class="preferences-section" style="margin: 20px 0;">
                            <h3>Configurações Gerais</h3>
                            <div class="preference-item" style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="checkbox" id="pref-notifications" checked> Ativar notificações
                                </label>
                            </div>
                            <div class="preference-item" style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="checkbox" id="pref-dark-mode"> Modo escuro
                                </label>
                            </div>
                            <div class="preference-item" style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 5px;">Horário de trabalho:</label>
                                <input type="time" id="pref-work-start" value="09:00" style="margin-right: 10px;">
                                até
                                <input type="time" id="pref-work-end" value="18:00" style="margin-left: 10px;">
                            </div>
                            <div class="preference-item" style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 5px;">Intervalo de lembretes (minutos):</label>
                                <input type="number" id="pref-reminder-interval" value="30" min="5" max="120" style="width: 100px;">
                            </div>
                            <button onclick="savePreferences()" style="margin-top: 20px; padding: 10px 30px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Salvar Preferências</button>
                        </div>
                    </div>
                </div>

                <!-- Aba Backup -->
                <div id="content-backup" class="tab-content" style="display: none;">
                    <div class="backup-container">
                        <!-- Status do Sistema -->
                        <div class="card backup-status-card">
                            <div class="card-header">
                                <h2>💾 Status do Sistema de Backup</h2>
                                <button id="refresh-backup-status" class="refresh-btn">🔄 Atualizar</button>
                            </div>
                            <div class="backup-status-grid" id="backup-status">
                                <!-- Carregado via JS -->
                            </div>
                        </div>

                        <!-- Versão Atual -->
                        <div class="card version-card">
                            <div class="card-header">
                                <h2>🏷️ Versão Atual</h2>
                                <div class="version-actions">
                                    <button id="create-program-backup" class="action-btn primary">💾 Backup do Programa</button>
                                    <button id="promote-version" class="action-btn warning">⬆️ Promover Versão</button>
                                </div>
                            </div>
                            <div class="version-info" id="current-version">
                                <!-- Carregado via JS -->
                            </div>
                        </div>

                        <!-- Backup de Dados -->
                        <div class="card data-backup-card">
                            <div class="card-header">
                                <h2>📊 Backup de Dados</h2>
                                <div class="backup-actions">
                                    <button id="create-data-backup" class="action-btn success">➕ Criar Backup</button>
                                    <button id="auto-backup-toggle" class="action-btn info">🔄 Auto Backup: ON</button>
                                </div>
                            </div>
                            <div class="backup-list" id="data-backups">
                                <!-- Lista de backups carregada via JS -->
                            </div>
                        </div>

                        <!-- Histórico de Versões -->
                        <div class="card version-history-card">
                            <div class="card-header">
                                <h2>📜 Histórico de Versões</h2>
                            </div>
                            <div class="version-timeline" id="version-history">
                                <!-- Timeline carregada via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- KANBAN DRAWER -->
    <div class="kanban-drawer" id="kanban-drawer">
        <div class="drawer-overlay" id="drawer-overlay"></div>
        <div class="drawer-content">
            <div class="drawer-header">
                <h2 id="drawer-project-title">Projeto - Kanban</h2>
                <button class="drawer-close" id="drawer-close">✕</button>
            </div>
            
            <div class="kanban-board">
                <div class="kanban-column">
                    <div class="column-header">
                        <span class="column-title">A fazer</span>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-content" data-status="A fazer" id="column-todo">
                        <!-- Tasks will be added here -->
                    </div>
                    <button class="add-task-btn" data-status="A fazer">+ Adicionar tarefa</button>
                </div>
                
                <div class="kanban-column">
                    <div class="column-header">
                        <span class="column-title">Fazendo</span>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-content" data-status="Fazendo" id="column-doing">
                        <!-- Tasks will be added here -->
                    </div>
                    <button class="add-task-btn" data-status="Fazendo">+ Adicionar tarefa</button>
                </div>
                
                <div class="kanban-column">
                    <div class="column-header">
                        <span class="column-title">Bloqueada</span>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-content" data-status="Bloqueada" id="column-blocked">
                        <!-- Tasks will be added here -->
                    </div>
                    <button class="add-task-btn" data-status="Bloqueada">+ Adicionar tarefa</button>
                </div>
                
                <div class="kanban-column">
                    <div class="column-header">
                        <span class="column-title">Concluída</span>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-content" data-status="Concluída" id="column-done">
                        <!-- Tasks will be added here -->
                    </div>
                    <button class="add-task-btn" data-status="Concluída">+ Adicionar tarefa</button>
                </div>
                
                <div class="kanban-column">
                    <div class="column-header">
                        <span class="column-title">Adiada</span>
                        <span class="task-count">0</span>
                    </div>
                    <div class="column-content" data-status="Adiada" id="column-postponed">
                        <!-- Tasks will be added here -->
                    </div>
                    <button class="add-task-btn" data-status="Adiada">+ Adicionar tarefa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for New Layout -->
    <script>
        // Tab Navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching functionality
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => {
                        c.classList.remove('active');
                        c.style.display = 'none';
                    });
                    
                    // Add active class to clicked tab
                    btn.classList.add('active');
                    
                    // Show corresponding content
                    const contentId = 'content-' + btn.getAttribute('data-content');
                    const content = document.getElementById(contentId);
                    if (content) {
                        content.classList.add('active');
                        content.style.display = 'block';

                        // Se for a aba do calendário, inicializar o calendário
                        if (btn.getAttribute('data-content') === 'calendario') {
                            initCalendar();
                        }
                    }
                });
            });

            // Sidebar navigation -> switch to content directly
            const navItems = document.querySelectorAll('.nav-item');
            const tabMap = {
                'dashboard': 'dashboard',
                'hoje': 'hoje',
                'calendario': 'calendario',
                'projetos': 'projetos',
                'tarefas': 'tarefas',
                'recorrentes': 'recorrentes',
                'relatorios': 'relatorios',
                'preferencias': 'preferencias',
                'backup': 'backup'
            };

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();

                    // update active state on sidebar
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    // Hide all content
                    tabContents.forEach(c => {
                        c.classList.remove('active');
                        c.style.display = 'none';
                    });

                    // Show the selected content
                    const key = item.getAttribute('data-tab');
                    const target = tabMap[key] || 'hoje';
                    const targetContent = document.getElementById(`content-${target}`);
                    
                    if (targetContent) {
                        targetContent.classList.add('active');
                        targetContent.style.display = 'block';
                        
                        // Update top tab if it exists
                        const targetBtn = document.querySelector(`.tab-btn[data-content="${target}"]`);
                        if (targetBtn) {
                            tabBtns.forEach(b => b.classList.remove('active'));
                            targetBtn.classList.add('active');
                        }
                        
                        // Load content for specific tabs
                        if (target === 'dashboard') {
                            // Carregar Dashboard de 60 dias
                            if (typeof loadDashboard60Days === 'function') {
                                loadDashboard60Days();
                            }
                        } else if (target === 'hoje') {
                            // Carregar conteúdo do dia
                            if (typeof loadHojeContent === 'function') {
                                loadHojeContent();
                            }
                        } else if (target === 'tarefas') {
                            loadTasksList();
                        } else if (target === 'relatorios') {
                            // Will load report when tab is selected
                        } else if (target === 'preferencias') {
                            loadPreferences();
                        } else if (target === 'backup') {
                            initBackupInterface();
                        }
                    }
                });
            });
            
            // Load project cards
            loadProjectCards();
            
            // Load tasks for "Hoje" tab
            loadHojeContent();
            
            // Load calendar for "Calendário" tab
            initCalendar();
        });

        // Project Cards Generation
        async function loadProjectCards() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();
                const projectsGrid = document.getElementById('projects-grid');
                
                if (!projectsGrid) return;
                
                projectsGrid.innerHTML = projects.map(project => {
                    const progress = calculateProjectProgress(project);
                    const statusClass = getStatusClass(progress);
                    const daysUntilDeadline = calculateDaysUntilDeadline(project.deadline);
                    
                    return `
                        <div class="project-card ${statusClass}" data-project-id="${project.id}">
                            <div class="project-header">
                                <h3>${project.title}</h3>
                                <div class="project-progress">
                                    <span class="progress-text">${progress}%</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="project-body">
                                <p class="project-description">${project.description || 'Sem descrição'}</p>
                                
                                <div class="project-meta">
                                    <div class="deadline-info">
                                        <span class="deadline-label">📅 Deadline:</span>
                                        <span class="deadline-date">${formatDate(project.deadline)}</span>
                                        <span class="days-remaining ${daysUntilDeadline <= 3 ? 'urgent' : ''}">${daysUntilDeadline} dias</span>
                                    </div>
                                    
                                    <div class="project-stats">
                                        <span class="stat">📋 \${countProjectTasks(project)} tarefas</span>
                                        <span class="stat">✅ \${countCompletedTasks(project)} concluídas</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="project-actions">
                                <button class="btn-secondary" onclick="openProject(${project.id})">Abrir</button>
                                <button class="btn-primary" onclick="editProject(${project.id})">Editar</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }
        
        // Helper functions for project cards
        function calculateProjectProgress(project) {
            return project.progress || 0;
        }
        
        function getStatusClass(progress) {
            if (progress >= 80) return 'status-good';
            if (progress >= 40) return 'status-warning';
            return 'status-danger';
        }
        
        function calculateDaysUntilDeadline(deadline) {
            const today = new Date();
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        function countProjectTasks(project) {
            return 0; // Simplified for now
        }
        
        function countCompletedTasks(project) {
            return 0; // Simplified for now  
        }
        
        function openProject(projectId) {
            openKanbanDrawer(projectId);
        }
        
        function editProject(projectId) {
            console.log('Editing project:', projectId);
        }

        // Kanban Drawer Functions
        function openKanbanDrawer(projectId) {
            const drawer = document.getElementById('kanban-drawer');
            const projectTitle = document.getElementById('drawer-project-title');
            
            // Set project title (you can fetch this from API if needed)
            projectTitle.textContent = `Projeto ${projectId} - Kanban`;
            
            // Show drawer
            drawer.classList.add('open');
            
            // Load project tasks
            loadProjectTasks(projectId);
        }

        function closeKanbanDrawer() {
            const drawer = document.getElementById('kanban-drawer');
            drawer.classList.remove('open');
        }

        async function loadProjectTasks(projectId) {
            try {
                // For now, create sample tasks - in real app, fetch from API
                const sampleTasks = [
                    { id: 1, titulo: 'Criar wireframe', status: 'A fazer', tipo: 'tarefa', projeto_id: projectId },
                    { id: 2, titulo: 'Definir arquitetura', status: 'Fazendo', tipo: 'marco', projeto_id: projectId },
                    { id: 3, titulo: 'Implementar frontend', status: 'A fazer', tipo: 'tarefa', projeto_id: projectId },
                    { id: 4, titulo: 'Setup banco de dados', status: 'Concluída', tipo: 'tarefa', projeto_id: projectId },
                    { id: 5, titulo: 'Revisar código', status: 'Repetitiva', tipo: 'repetitiva', projeto_id: projectId }
                ];

                // Clear columns
                document.querySelectorAll('.column-content').forEach(column => {
                    column.innerHTML = '';
                });

                // Add tasks to appropriate columns
                sampleTasks.forEach(task => {
                    addTaskToColumn(task);
                });

                // Update task counts
                updateTaskCounts();
            } catch (error) {
                console.error('Error loading project tasks:', error);
            }
        }

        function addTaskToColumn(task) {
            const statusMap = {
                'A fazer': 'column-todo',
                'Fazendo': 'column-doing', 
                'Bloqueada': 'column-blocked',
                'Concluída': 'column-done',
                'Adiada': 'column-postponed'
            };

            const columnId = statusMap[task.status];
            const column = document.getElementById(columnId);
            
            if (column) {
                const taskElement = createTaskElement(task);
                column.appendChild(taskElement);
            }
        }

        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            taskEl.className = 'kanban-task';
            taskEl.draggable = true;
            taskEl.dataset.taskId = task.id;
            
            taskEl.innerHTML = `
                <div class="kanban-task-title">${task.titulo}</div>
                <div class="kanban-task-meta">
                    <span class="task-type-badge ${task.tipo}">${task.tipo}</span>
                    ${task.due_date ? `<span>📅 ${formatDate(task.due_date)}</span>` : ''}
                </div>
            `;

            // Add drag and drop event listeners
            taskEl.addEventListener('dragstart', handleTaskDragStart);
            taskEl.addEventListener('dragend', handleTaskDragEnd);
            
            return taskEl;
        }

        function updateTaskCounts() {
            document.querySelectorAll('.kanban-column').forEach(column => {
                const content = column.querySelector('.column-content');
                const countSpan = column.querySelector('.task-count');
                const taskCount = content.querySelectorAll('.kanban-task').length;
                countSpan.textContent = taskCount;
            });
        }

        // Drag and Drop functionality
        function handleTaskDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            e.target.classList.add('dragging');
        }

        function handleTaskDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function setupDragAndDrop() {
            document.querySelectorAll('.column-content').forEach(column => {
                column.addEventListener('dragover', handleColumnDragOver);
                column.addEventListener('drop', handleColumnDrop);
                column.addEventListener('dragenter', handleColumnDragEnter);
                column.addEventListener('dragleave', handleColumnDragLeave);
            });
        }

        function handleColumnDragOver(e) {
            e.preventDefault();
        }

        function handleColumnDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleColumnDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over');
            }
        }

        function handleColumnDrop(e) {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('text/plain');
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            const newStatus = e.currentTarget.dataset.status;
            
            if (taskElement) {
                // Move task to new column
                e.currentTarget.appendChild(taskElement);
                
                // Update task status (here you would call API)
                console.log(`Task ${taskId} moved to ${newStatus}`);
                
                // Update task counts
                updateTaskCounts();
            }
            
            e.currentTarget.classList.remove('drag-over');
        }

        // Initialize drawer functionality when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Drawer close handlers
            const drawerClose = document.getElementById('drawer-close');
            const drawerOverlay = document.getElementById('drawer-overlay');
            
            if (drawerClose) {
                drawerClose.addEventListener('click', closeKanbanDrawer);
            }
            
            if (drawerOverlay) {
                drawerOverlay.addEventListener('click', closeKanbanDrawer);
            }
            
            // Setup drag and drop
            setupDragAndDrop();
            
            // Add task button handlers
            document.querySelectorAll('.add-task-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const status = this.dataset.status;
                    // Here you would show a form to add a new task
                    console.log(`Add task to ${status} column`);
                });
            });
        });
        
        // Variáveis globais para timer
        let timerInterval = null;
        let timerSeconds = 1500; // 25 minutos em segundos
        let isTimerRunning = false;
        let currentMode = 'pomodoro'; // 'pomodoro' ou 'break'
        let currentFilter = 'all';

        // Load content for "Hoje" tab
        async function loadHojeContent() {
            try {
                await Promise.all([
                    loadDashboardStats(),
                    loadEnhancedTasks(),
                    loadMeetings(),
                    loadTimeline()
                ]);
            } catch (error) {
                console.error('Error loading today content:', error);
            }
        }

        // Carregar Dashboard de 60 dias
        async function loadDashboard60Days() {
            try {
                const today = new Date();
                const endDate = new Date(today);
                endDate.setDate(endDate.getDate() + 60);

                // Atualizar período
                document.getElementById('period-range').textContent =
                    `${today.toLocaleDateString('pt-BR')} - ${endDate.toLocaleDateString('pt-BR')}`;

                // Carregar dados
                const [tasksResponse, projectsResponse, meetingsResponse] = await Promise.all([
                    fetch('/api/tasks'),
                    fetch('/api/projects'),
                    fetch('/api/meetings')
                ]);

                const tasks = await tasksResponse.json();
                const projects = await projectsResponse.json();
                const meetings = meetingsResponse.ok ? await meetingsResponse.json() : [];

                // Filtrar eventos dos próximos 60 dias
                const next60DaysTasks = tasks.filter(task => {
                    const taskDate = new Date(task.date);
                    return taskDate >= today && taskDate <= endDate;
                });

                const next60DaysMeetings = meetings.filter(meeting => {
                    const meetingDate = new Date(meeting.date);
                    return meetingDate >= today && meetingDate <= endDate;
                });

                // Contar eventos por categoria
                const flights = next60DaysTasks.filter(t => t.category === 'voo').length;
                const travels = next60DaysTasks.filter(t => t.category === 'viagem').length;
                const activeProjects = projects.filter(p => {
                    const deadline = new Date(p.deadline);
                    return deadline <= endDate && p.progress < 100;
                }).length;

                // Atualizar métricas
                document.getElementById('total-events-60').textContent =
                    next60DaysTasks.length + next60DaysMeetings.length;
                document.getElementById('total-meetings-60').textContent = next60DaysMeetings.length;
                document.getElementById('total-tasks-60').textContent = next60DaysTasks.length;
                document.getElementById('total-flights-60').textContent = flights;
                document.getElementById('total-travels-60').textContent = travels;
                document.getElementById('projects-active-60').textContent = activeProjects;

                // Gerar timeline dos próximos 60 dias
                generateTimeline60Days(next60DaysTasks, next60DaysMeetings, projects);

                // Gerar lista de projetos com deadline
                generateProjectsDeadline(projects, endDate);

                // Gerar cronograma de viagens
                generateTravelSchedule(next60DaysTasks);

                // Gerar gráfico de carga de trabalho
                generateWorkloadChart(next60DaysTasks, next60DaysMeetings);

            } catch (error) {
                console.error('Error loading 60 days dashboard:', error);
            }
        }

        function generateTimeline60Days(tasks, meetings, projects) {
            const timeline = document.getElementById('timeline-60days');
            if (!timeline) return;

            const events = [];

            // Adicionar tarefas importantes
            tasks.filter(t => t.priority === 'alta' || t.category === 'voo' || t.category === 'viagem')
                .forEach(task => {
                    events.push({
                        date: new Date(task.date),
                        type: task.category === 'voo' ? 'flight' : task.category === 'viagem' ? 'travel' : 'task',
                        title: task.title,
                        icon: task.category === 'voo' ? '✈️' : task.category === 'viagem' ? '🌍' : '📋'
                    });
                });

            // Adicionar reuniões
            meetings.forEach(meeting => {
                events.push({
                    date: new Date(meeting.date),
                    type: 'meeting',
                    title: meeting.title,
                    icon: '📅'
                });
            });

            // Adicionar deadlines de projetos
            projects.filter(p => p.progress < 100).forEach(project => {
                events.push({
                    date: new Date(project.deadline),
                    type: 'deadline',
                    title: `Deadline: ${project.title}`,
                    icon: '🎯'
                });
            });

            // Ordenar por data
            events.sort((a, b) => a.date - b.date);

            // Limitar a 20 eventos mais próximos
            const topEvents = events.slice(0, 20);

            timeline.innerHTML = topEvents.map(event => `
                <div class="timeline-60days-item ${event.type}">
                    <div class="timeline-60days-date">
                        ${event.date.toLocaleDateString('pt-BR')}
                    </div>
                    <div class="timeline-60days-content">
                        ${event.icon} ${event.title}
                    </div>
                </div>
            `).join('');
        }

        function generateProjectsDeadline(projects, endDate) {
            const container = document.getElementById('projects-deadline-60');
            if (!container) return;

            const projectsWithDeadline = projects.filter(p => {
                const deadline = new Date(p.deadline);
                return deadline <= endDate && p.progress < 100;
            }).sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

            if (projectsWithDeadline.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">Nenhum projeto com prazo nos próximos 60 dias</p>';
                return;
            }

            container.innerHTML = projectsWithDeadline.map(project => {
                const daysLeft = Math.ceil((new Date(project.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                const urgencyClass = daysLeft <= 7 ? 'urgent' : daysLeft <= 30 ? 'warning' : '';

                return `
                    <div class="project-deadline-item ${urgencyClass}">
                        <div>
                            <div class="project-deadline-name">${project.title}</div>
                            <div class="progress-bar" style="width: 200px; height: 4px; background: var(--muted); margin-top: 4px;">
                                <div style="width: ${project.progress}%; height: 100%; background: var(--primary);"></div>
                            </div>
                        </div>
                        <div>
                            <div class="project-deadline-date">${new Date(project.deadline).toLocaleDateString('pt-BR')}</div>
                            <div style="font-size: 11px; color: ${daysLeft <= 7 ? 'var(--danger)' : 'var(--text-muted)'};">
                                ${daysLeft} dias restantes
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateTravelSchedule(tasks) {
            const container = document.getElementById('travel-schedule-60');
            if (!container) return;

            const travels = tasks.filter(t => t.category === 'voo' || t.category === 'viagem')
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (travels.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">Nenhuma viagem programada nos próximos 60 dias</p>';
                return;
            }

            container.innerHTML = travels.map(travel => {
                const flag = travel.location ? countryData[travel.location]?.flag || '🌍' : '🌍';
                return `
                    <div class="travel-schedule-item">
                        <div class="travel-flag">${flag}</div>
                        <div class="travel-details">
                            <div class="travel-destination">${travel.title}</div>
                            <div class="travel-dates">
                                ${new Date(travel.date).toLocaleDateString('pt-BR')}
                                ${travel.time ? `às ${travel.time}` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateWorkloadChart(tasks, meetings) {
            const container = document.getElementById('workload-chart-60');
            if (!container) return;

            // Agrupar eventos por semana
            const weeks = {};
            const today = new Date();

            for (let i = 0; i < 9; i++) { // 9 semanas = ~60 dias
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() + (i * 7));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);

                const weekKey = `Sem ${i + 1}`;
                weeks[weekKey] = 0;

                // Contar eventos da semana
                tasks.forEach(task => {
                    const taskDate = new Date(task.date);
                    if (taskDate >= weekStart && taskDate <= weekEnd) {
                        weeks[weekKey]++;
                    }
                });

                meetings.forEach(meeting => {
                    const meetingDate = new Date(meeting.date);
                    if (meetingDate >= weekStart && meetingDate <= weekEnd) {
                        weeks[weekKey]++;
                    }
                });
            }

            const maxEvents = Math.max(...Object.values(weeks), 1);

            container.innerHTML = Object.entries(weeks).map(([week, count]) => {
                const height = (count / maxEvents) * 100;
                return `
                    <div class="workload-bar" style="height: ${height}%;" title="${count} eventos">
                        <div class="workload-bar-label">${week}</div>
                    </div>
                `;
            }).join('');
        }

        // Carregar estatísticas do dashboard (mantido para compatibilidade)
        async function loadDashboardStats() {
            // Chamar a nova função de 60 dias
            await loadDashboard60Days();
        }

        // Carregar tarefas melhoradas
        async function loadEnhancedTasks() {
            try {
                const response = await fetch('/api/tasks');
                const tasks = await response.json();
                const today = new Date().toISOString().split('T')[0];

                let todayTasks = tasks.filter(task => task.date === today);

                // Aplicar filtro
                if (currentFilter !== 'all') {
                    todayTasks = todayTasks.filter(task => task.priority === currentFilter);
                }

                // Ordenar por prioridade e hora
                todayTasks.sort((a, b) => {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    return (a.time || '').localeCompare(b.time || '');
                });

                const proximasAcoes = document.getElementById('proximas-acoes');
                if (proximasAcoes) {
                    if (todayTasks.length === 0) {
                        proximasAcoes.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhuma tarefa para hoje</p>';
                    } else {
                        proximasAcoes.innerHTML = todayTasks.map(task => `
                            <div class="task-item" data-task-id="${task.id}">
                                <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})">
                                <div class="task-priority ${task.priority}"></div>
                                <div class="task-content">
                                    <div class="task-title ${task.completed ? 'completed' : ''}">${task.title}</div>
                                    <div class="task-meta">
                                        ${task.time ? `🕰️ ${task.time}` : ''}
                                        ${task.project ? `📁 ${task.project}` : ''}
                                        ${task.estimatedTime ? `⏱️ ${task.estimatedTime}min` : ''}
                                    </div>
                                </div>
                                <div class="task-actions">
                                    <button class="task-action-btn" onclick="editTask(${task.id})">✏️</button>
                                    <button class="task-action-btn" onclick="deleteTask(${task.id})">🗑️</button>
                                    <button class="task-action-btn" onclick="startTaskTimer(${task.id})">▶️</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading enhanced tasks:', error);
            }
        }

        // Carregar reuniões
        async function loadMeetings() {
            try {
                const response = await fetch('/api/meetings');
                const meetings = await response.json();
                const today = new Date().toISOString().split('T')[0];

                const todayMeetings = meetings.filter(meeting => meeting.date === today);
                todayMeetings.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

                const reunioesHoje = document.getElementById('reunioes-hoje');
                if (reunioesHoje) {
                    if (todayMeetings.length === 0) {
                        reunioesHoje.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhuma reunião agendada para hoje</p>';
                    } else {
                        reunioesHoje.innerHTML = todayMeetings.map(meeting => `
                            <div class="meeting-item">
                                <div class="meeting-time">${meeting.time} - ${addMinutesToTime(meeting.time, meeting.duration)}</div>
                                <div class="meeting-content">
                                    <div class="meeting-title">${meeting.title}</div>
                                    <div class="meeting-details">
                                        📍 ${meeting.location} | 👥 ${meeting.participants.join(', ')}
                                        ${meeting.link ? ` | <a href="${meeting.link}" target="_blank">🔗 Link</a>` : ''}
                                    </div>
                                </div>
                                <div class="meeting-actions">
                                    <button class="meeting-action-btn" onclick="editMeeting(${meeting.id})">✏️</button>
                                    <button class="meeting-action-btn" onclick="deleteMeeting(${meeting.id})">🗑️</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading meetings:', error);
            }
        }

        // Carregar timeline
        async function loadTimeline() {
            try {
                const [tasksResponse, meetingsResponse] = await Promise.all([
                    fetch('/api/tasks'),
                    fetch('/api/meetings')
                ]);

                const tasks = await tasksResponse.json();
                const meetings = await meetingsResponse.json();
                const today = new Date().toISOString().split('T')[0];

                const todayTasks = tasks.filter(task => task.date === today && task.time);
                const todayMeetings = meetings.filter(meeting => meeting.date === today);

                const timelineItems = [
                    ...todayTasks.map(task => ({ ...task, type: 'task', time: task.time })),
                    ...todayMeetings.map(meeting => ({ ...meeting, type: 'meeting', time: meeting.time }))
                ];

                timelineItems.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

                const timelineContainer = document.getElementById('timeline-container');
                if (timelineContainer) {
                    if (timelineItems.length === 0) {
                        timelineContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhum evento agendado para hoje</p>';
                    } else {
                        timelineContainer.innerHTML = timelineItems.map(item => {
                            const typeLabel = item.type === 'task' ? 'Tarefa' :
                                            item.type === 'meeting' ? 'Reunião' :
                                            item.category === 'voo' ? '✈️ Voo' :
                                            item.category === 'viagem' ? '🌍 Viagem' : item.type;
                            return `
                                <div class="timeline-item ${item.category === 'voo' || item.category === 'viagem' ? 'travel-block' : ''}">
                                    <div class="timeline-time">${item.time}</div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">${item.title}</div>
                                        <span class="timeline-type">${typeLabel}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                // Atualizar resumo do dia
                updateDaySummary(new Date(), timelineItems);
            } catch (error) {
                console.error('Error loading timeline:', error);
            }
        }
        
        function getTaskTypeIcon(tipo) {
            switch (tipo) {
                case 'marco': return '🎯';
                case 'repetitiva': return '🔄';
                default: return '📋';
            }
        }

        // Funções utilitárias
        function addMinutesToTime(time, minutes) {
            const [hours, mins] = time.split(':').map(Number);
            const totalMinutes = hours * 60 + mins + minutes;
            const newHours = Math.floor(totalMinutes / 60) % 24;
            const newMins = totalMinutes % 60;
            return `${String(newHours).padStart(2, '0')}:${String(newMins).padStart(2, '0')}`;
        }

        // Funções de interação com tarefas
        async function toggleTask(taskId) {
            try {
                const response = await fetch('/api/tasks');
                const tasks = await response.json();
                const task = tasks.find(t => t.id === taskId);

                if (task) {
                    task.completed = !task.completed;
                    await fetch(`/api/tasks/${taskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(task)
                    });

                    await loadHojeContent();
                }
            } catch (error) {
                console.error('Error toggling task:', error);
            }
        }

        async function deleteTask(taskId) {
            if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                try {
                    await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
                    await loadHojeContent();
                } catch (error) {
                    console.error('Error deleting task:', error);
                }
            }
        }

        function editTask(taskId) {
            // Navegar para a aba de tarefas e abrir edição
            const taskTab = document.querySelector('[data-tab="tarefas"]');
            if (taskTab) {
                taskTab.click();
                // Buscar a tarefa na lista e destacar
                setTimeout(() => {
                    const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                    if (taskElement) {
                        taskElement.style.background = 'var(--accent)';
                        taskElement.scrollIntoView({ behavior: 'smooth' });
                        setTimeout(() => {
                            taskElement.style.background = '';
                        }, 2000);
                    }
                }, 100);
            }
        }

        function startTaskTimer(taskId) {
            // Iniciar timer focado na tarefa
            const response = confirm('Iniciar timer de 25 minutos para esta tarefa?');
            if (response) {
                // Reset e iniciar timer
                resetTimer();
                setTimerMode('pomodoro');
                startTimer();

                // Opcional: notificar qual tarefa está sendo cronometrada
                if (Notification.permission === 'granted') {
                    new Notification('Timer iniciado!', {
                        body: 'Pomodoro de 25 minutos iniciado para a tarefa.',
                        icon: '/icon.png'
                    });
                }
            }
        }

        // Funções de reuniões
        async function editMeeting(meetingId) {
            try {
                const response = await fetch('/api/meetings');
                const meetings = await response.json();
                const meeting = meetings.find(m => m.id === meetingId);

                if (meeting) {
                    const newTitle = prompt('Título da reunião:', meeting.title);
                    if (newTitle && newTitle !== meeting.title) {
                        meeting.title = newTitle;
                        await fetch(`/api/meetings/${meetingId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(meeting)
                        });
                        await loadMeetings();
                    }
                }
            } catch (error) {
                console.error('Error editing meeting:', error);
                alert('Erro ao editar reunião.');
            }
        }

        async function deleteMeeting(meetingId) {
            if (confirm('Tem certeza que deseja excluir esta reunião?')) {
                try {
                    await fetch(`/api/meetings/${meetingId}`, { method: 'DELETE' });
                    await loadMeetings();
                } catch (error) {
                    console.error('Error deleting meeting:', error);
                }
            }
        }

        // Funções do Timer Pomodoro
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timer-display').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    updateTimerDisplay();

                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        isTimerRunning = false;

                        // Notificação de fim do timer
                        if (Notification.permission === 'granted') {
                            new Notification('Timer concluído!', {
                                body: currentMode === 'pomodoro' ? 'Hora da pausa!' : 'Volte ao trabalho!',
                                icon: '/icon.png'
                            });
                        }

                        // Auto switch para o próximo modo
                        if (currentMode === 'pomodoro') {
                            setTimerMode('break');
                        } else {
                            setTimerMode('pomodoro');
                        }
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            timerSeconds = currentMode === 'pomodoro' ? 1500 : 300; // 25min ou 5min
            updateTimerDisplay();
        }

        function setTimerMode(mode) {
            currentMode = mode;
            timerSeconds = mode === 'pomodoro' ? 1500 : 300; // 25min ou 5min
            updateTimerDisplay();

            // Atualizar UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${mode}-mode`).classList.add('active');
        }

        // Função de Quick Add
        async function processQuickAdd(input) {
            const text = input.toLowerCase().trim();

            // Parser simples para extrair informações
            let title = text;
            let time = '';
            let date = new Date().toISOString().split('T')[0]; // hoje por padrão

            // Extrair horário (formato: às 14h, às 14:30, 14h30)
            const timeMatch = text.match(/(às? ?(\d{1,2}):?(\d{0,2})h?\d{0,2})/i);
            if (timeMatch) {
                const hours = timeMatch[2].padStart(2, '0');
                const minutes = (timeMatch[3] || '00').padStart(2, '0');
                time = `${hours}:${minutes}`;
                title = title.replace(timeMatch[0], '').trim();
            }

            // Extrair data (amanhã, hoje)
            if (text.includes('amanhã')) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                date = tomorrow.toISOString().split('T')[0];
                title = title.replace(/amanhã/gi, '').trim();
            }

            // Criar tarefa
            const newTask = {
                title: title,
                description: '',
                date: date,
                time: time,
                priority: 'medium',
                category: 'trabalho',
                completed: false,
                reminder: true
            };

            try {
                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newTask)
                });

                await loadHojeContent();
                document.getElementById('quick-add-input').value = '';
            } catch (error) {
                console.error('Error adding quick task:', error);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Quick Add
            const quickAddInput = document.getElementById('quick-add-input');
            const quickAddBtn = document.getElementById('quick-add-btn');

            if (quickAddBtn) {
                quickAddBtn.addEventListener('click', () => {
                    const input = quickAddInput.value.trim();
                    if (input) processQuickAdd(input);
                });
            }

            if (quickAddInput) {
                quickAddInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const input = quickAddInput.value.trim();
                        if (input) processQuickAdd(input);
                    }
                });
            }

            // Timer controls
            const timerStart = document.getElementById('timer-start');
            const timerPause = document.getElementById('timer-pause');
            const timerReset = document.getElementById('timer-reset');
            const pomodoroMode = document.getElementById('pomodoro-mode');
            const breakMode = document.getElementById('break-mode');

            if (timerStart) timerStart.addEventListener('click', startTimer);
            if (timerPause) timerPause.addEventListener('click', pauseTimer);
            if (timerReset) timerReset.addEventListener('click', resetTimer);
            if (pomodoroMode) pomodoroMode.addEventListener('click', () => setTimerMode('pomodoro'));
            if (breakMode) breakMode.addEventListener('click', () => setTimerMode('break'));

            // Task filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    loadEnhancedTasks();
                });
            });

            // Initialize timer display
            updateTimerDisplay();

            // Auto-refresh data every 5 minutes
            setInterval(() => {
                if (document.querySelector('#content-hoje.active')) {
                    loadHojeContent();
                }
            }, 300000); // 5 minutes

            // Search functionality
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(performSearch, 300));
            }
        });

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Função para abrir a página do projeto
        function openProjectView() {
            // Abrir em nova janela
            window.open('./projeto/projeto.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        // ========================
        // SISTEMA DE BACKUP
        // ========================

        // Carregar status do backup
        async function loadBackupStatus() {
            try {
                const response = await fetch('/api/backup/status');
                const status = await response.json();

                const statusContainer = document.getElementById('backup-status');
                if (statusContainer) {
                    statusContainer.innerHTML = `
                        <div class="status-widget">
                            <h4>📊 Backups de Dados</h4>
                            <div class="status-number">${status.dataBackups.count}</div>
                            <div class="status-label">Total de backups</div>
                        </div>
                        <div class="status-widget">
                            <h4>🕓 Último Backup</h4>
                            <div class="status-number">${status.dataBackups.latest ? formatDate(status.dataBackups.latest.timestamp) : 'Nenhum'}</div>
                            <div class="status-label">Data do último backup</div>
                        </div>
                        <div class="status-widget">
                            <h4>💾 Tamanho Total</h4>
                            <div class="status-number">${formatBytes(status.dataBackups.totalSize)}</div>
                            <div class="status-label">Espaço utilizado</div>
                        </div>
                        <div class="status-widget">
                            <h4>🏷️ Versões</h4>
                            <div class="status-number">${status.versionHistory.count}</div>
                            <div class="status-label">Versões criadas</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar status do backup:', error);
            }
        }

        // Carregar versão atual
        async function loadCurrentVersion() {
            try {
                const response = await fetch('/api/backup/version/current');
                const version = await response.json();

                const versionContainer = document.getElementById('current-version');
                if (versionContainer) {
                    versionContainer.innerHTML = `
                        <div class="version-detail">
                            <h5>Nome da Versão</h5>
                            <div class="version-value">${version.name}</div>
                        </div>
                        <div class="version-detail">
                            <h5>Número</h5>
                            <div class="version-value">v${version.major}.${version.minor}.${version.patch}</div>
                        </div>
                        <div class="version-detail">
                            <h5>Estágio</h5>
                            <div class="version-value">
                                <span class="version-stage ${version.stage}">${version.stage}</span>
                            </div>
                        </div>
                        <div class="version-detail">
                            <h5>Criada em</h5>
                            <div class="version-value">${formatDate(version.timestamp)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar versão atual:', error);
            }
        }

        // Carregar lista de backups de dados
        async function loadDataBackups() {
            try {
                const response = await fetch('/api/backup/data');
                const backups = await response.json();

                const backupsContainer = document.getElementById('data-backups');
                if (backupsContainer) {
                    if (backups.length === 0) {
                        backupsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhum backup encontrado</p>';
                    } else {
                        backupsContainer.innerHTML = backups.map(backup => `
                            <div class="backup-item">
                                <div class="backup-info">
                                    <div class="backup-label">${backup.label}</div>
                                    <div class="backup-meta">
                                        ${formatDate(backup.timestamp)} | ${backup.files.length} arquivos | ${formatBytes(backup.size)}
                                    </div>
                                </div>
                                <div class="backup-actions">
                                    <button class="backup-btn" onclick="restoreBackup('${backup.label}')">Restaurar</button>
                                    <button class="backup-btn" onclick="downloadBackup('${backup.label}')">Download</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar backups:', error);
            }
        }

        // Carregar histórico de versões
        async function loadVersionHistory() {
            try {
                const response = await fetch('/api/backup/versions');
                const versions = await response.json();

                const historyContainer = document.getElementById('version-history');
                if (historyContainer) {
                    if (versions.length === 0) {
                        historyContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhuma versão encontrada</p>';
                    } else {
                        historyContainer.innerHTML = versions.map(version => `
                            <div class="timeline-item">
                                <div class="timeline-content">
                                    <div class="timeline-version">
                                        ${version.name} v${version.major}.${version.minor}.${version.patch}
                                        <span class="version-stage ${version.stage}">${version.stage}</span>
                                    </div>
                                    <div class="timeline-meta">
                                        ${formatDate(version.created)} | Backup: ${version.backupLabel}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
            }
        }

        // Criar backup manual de dados
        async function createDataBackup() {
            const label = prompt('Nome do backup (opcional):');

            try {
                const response = await fetch('/api/backup/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Backup criado com sucesso!');
                    await loadBackupStatus();
                    await loadDataBackups();
                } else {
                    alert('Erro ao criar backup: ' + result.error);
                }
            } catch (error) {
                alert('Erro ao criar backup: ' + error.message);
            }
        }

        // Restaurar backup
        async function restoreBackup(label) {
            if (!confirm(`Tem certeza que deseja restaurar o backup "${label}"?\nOs dados atuais serão substituídos.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/backup/restore/${label}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Backup restaurado com sucesso!\nA aplicação será recarregada.');
                    window.location.reload();
                } else {
                    alert('Erro ao restaurar backup: ' + result.error);
                }
            } catch (error) {
                alert('Erro ao restaurar backup: ' + error.message);
            }
        }

        // Criar backup do programa
        async function createProgramBackup() {
            if (!confirm('Criar backup completo do programa?\nIsso pode demorar alguns minutos.')) {
                return;
            }

            try {
                const response = await fetch('/api/backup/program', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    alert('Backup do programa criado com sucesso!');
                    await loadVersionHistory();
                    await loadBackupStatus();
                } else {
                    alert('Erro ao criar backup: ' + result.error);
                }
            } catch (error) {
                alert('Erro ao criar backup: ' + error.message);
            }
        }

        // Promover versão
        async function promoteVersion() {
            const stages = ['alpha', 'beta', 'stable'];
            const stage = prompt('Para qual estágio promover? (alpha/beta/stable)');

            if (!stage || !stages.includes(stage)) {
                alert('Estágio inválido. Use: alpha, beta ou stable');
                return;
            }

            try {
                const response = await fetch(`/api/backup/promote/${stage}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Versão promovida para ${stage} com sucesso!`);
                    await loadCurrentVersion();
                    await loadVersionHistory();
                } else {
                    alert('Erro ao promover versão: ' + result.error);
                }
            } catch (error) {
                alert('Erro ao promover versão: ' + error.message);
            }
        }

        // Funções utilitárias
        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('pt-BR');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadBackup(label) {
            // Implementar download do backup
            alert('Funcionalidade de download será implementada em breve.');
        }

        // Inicializar interface de backup quando a aba for carregada
        function initBackupInterface() {
            // Adicionar event listeners para os botões de backup
            const btnCreateDataBackup = document.getElementById('btn-create-data-backup');
            const btnCreateProgramBackup = document.getElementById('btn-create-program-backup');
            const selectPromoteStage = document.getElementById('select-promote-stage');
            const btnPromoteVersion = document.getElementById('btn-promote-version');

            if (btnCreateDataBackup) {
                btnCreateDataBackup.addEventListener('click', createDataBackup);
            }

            if (btnCreateProgramBackup) {
                btnCreateProgramBackup.addEventListener('click', createProgramBackup);
            }

            if (btnPromoteVersion && selectPromoteStage) {
                btnPromoteVersion.addEventListener('click', () => {
                    const stage = selectPromoteStage.value;
                    if (stage) {
                        if (confirm(`Tem certeza que deseja promover a versão para ${stage}?`)) {
                            promoteVersion(stage);
                        }
                    } else {
                        alert('Selecione um estágio para promoção.');
                    }
                });
            }

            // Carregar status inicial
            loadBackupStatus();
        }

        // Search functionality
        function performSearch() {
            const searchTerm = document.querySelector('.search-input').value.toLowerCase();
            const taskItems = document.querySelectorAll('.task-item');
            const meetingItems = document.querySelectorAll('.meeting-item');

            // Filter tasks
            taskItems.forEach(item => {
                const title = item.querySelector('.task-title').textContent.toLowerCase();
                const meta = item.querySelector('.task-meta').textContent.toLowerCase();
                if (title.includes(searchTerm) || meta.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });

            // Filter meetings
            meetingItems.forEach(item => {
                const title = item.querySelector('.meeting-title').textContent.toLowerCase();
                const details = item.querySelector('.meeting-details').textContent.toLowerCase();
                if (title.includes(searchTerm) || details.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Simple calendar initialization 
        function initCalendar() {
            console.log('Calendar initialized for main content');
            // Reinicializar elementos do calendário
            prevMonth = document.getElementById('prev-month');
            nextMonth = document.getElementById('next-month');
            currentMonth = document.getElementById('current-month');
            calendarGrid = document.getElementById('calendar-grid');

            if (calendarGrid) {
                updateMonthDisplay();
                renderCalendar();
                setupCalendarNavigation();
            }
        }
    </script>
    
    
    <script>
        console.log('Step 3 script loading...');
        
        // Configuração da API
        const API_URL = 'http://localhost:3001/api';
        
        // Elementos
        const btnDashboard = document.getElementById('btn-dashboard');
        const btnTasks = document.getElementById('btn-tasks');
        const btnProjects = document.getElementById('btn-projects');
        const btnReports = document.getElementById('btn-reports');
        const prevMonth = document.getElementById('prev-month');
        const nextMonth = document.getElementById('next-month');
        const currentMonth = document.getElementById('current-month');
        const calendarGrid = document.getElementById('calendar-grid');
        const taskForm = document.getElementById('task-form');
        const recentTasks = document.getElementById('recent-tasks');
        const allTasks = document.getElementById('all-tasks');
        const projectForm = document.getElementById('project-form');
        const allProjects = document.getElementById('all-projects');
        const recentProjects = document.getElementById('recent-projects');
        const homeProjects = document.getElementById('home-projects');
        
        // Views
        const dashboardView = document.getElementById('dashboard-view');
        const tasksView = document.getElementById('tasks-view');
        const projectsView = document.getElementById('projects-view');
        const reportsView = document.getElementById('reports-view');
        
        // Variáveis
        let currentDate = new Date();
        let tasks = [];
        let projects = [];
        let meetings = [];
        let projectTasks = [];

        // Função para atualizar o relógio e data do sistema
        function updateSystemDateTime() {
            const now = new Date();

            // Atualizar hora
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = `${hours}:${minutes}:${seconds}`;
            }

            // Atualizar data
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            const dateString = now.toLocaleDateString('pt-BR', options);
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = dateString;
            }

            // Sincronizar currentDate com o sistema
            currentDate = new Date();
        }

        // Função para buscar eventos do dia
        function getEventsForDay(date) {
            const dateStr = date.toISOString().split('T')[0];
            const events = [];

            // Buscar tarefas
            if (tasks) {
                tasks.filter(t => t.due_date === dateStr).forEach(t => {
                    events.push({
                        type: 'task',
                        title: t.title,
                        time: t.time || '',
                        priority: t.priority
                    });
                });
            }

            // Buscar reuniões
            if (meetings) {
                meetings.filter(m => m.date === dateStr).forEach(m => {
                    events.push({
                        type: 'meeting',
                        title: m.title,
                        time: m.start_time,
                        location: m.location
                    });
                });
            }

            return events;
        }

        // Função para renderizar mini calendário
        function renderMiniCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const today = now.getDate();

            const monthNames = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            // Atualizar título
            const titleElement = document.getElementById('mini-calendar-title');
            if (titleElement) {
                titleElement.textContent = `${monthNames[month]} ${year}`;
            }

            // Gerar grid do calendário
            const gridElement = document.getElementById('mini-calendar-grid');
            if (gridElement) {
                let html = '';

                // Cabeçalhos dos dias da semana
                const dayHeaders = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                dayHeaders.forEach(day => {
                    html += `<div class="calendar-day header">${day}</div>`;
                });

                // Primeiro dia do mês e último dia
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = firstDay.getDay(); // 0 = domingo

                // Adicionar dias do mês anterior (se necessário)
                const prevMonth = new Date(year, month, 0);
                for (let i = startDay - 1; i >= 0; i--) {
                    const day = prevMonth.getDate() - i;
                    html += `<div class="calendar-day other-month">${day}</div>`;
                }

                // Adicionar dias do mês atual
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(year, month, day);
                    const events = getEventsForDay(date);
                    const classes = ['calendar-day'];

                    if (day === today) {
                        classes.push('today');
                    }

                    if (events.length > 0) {
                        classes.push('has-tasks');
                    }

                    // Criar tooltip com eventos
                    let tooltip = '';
                    if (events.length > 0) {
                        tooltip = `<div class="calendar-tooltip">`;
                        events.forEach(e => {
                            const icon = e.type === 'meeting' ? '📋' : '✓';
                            tooltip += `<div>${icon} ${e.time} ${e.title}</div>`;
                        });
                        tooltip += `</div>`;
                    }

                    html += `
                        <div class="${classes.join(' ')}"
                             data-date="${date.toISOString().split('T')[0]}"
                             data-events="${events.length}"
                             onclick="showDayDetails('${date.toISOString().split('T')[0]}')">
                            ${day}
                            ${tooltip}
                        </div>`;
                }

                // Adicionar dias do próximo mês para completar a grade
                const totalCells = 42; // 6 semanas * 7 dias
                const currentCells = 7 + startDay + lastDay.getDate();
                const remainingCells = totalCells - currentCells;

                for (let day = 1; day <= remainingCells; day++) {
                    html += `<div class="calendar-day other-month">${day}</div>`;
                }

                gridElement.innerHTML = html;
            }
        }

        // Função para mostrar detalhes do dia
        function showDayDetails(dateStr) {
            const date = new Date(dateStr);
            const events = getEventsForDay(date);

            // Atualizar o resumo do dia
            updateDaySummary(date, events);
        }

        // Função para atualizar resumo do dia
        function updateDaySummary(date, events) {
            const summaryElement = document.getElementById('day-summary');
            if (summaryElement) {
                let html = '';

                if (!events || events.length === 0) {
                    html = '<p style="color: var(--text-muted);">Nenhum evento agendado para hoje</p>';
                } else {
                    // Agrupar por categoria
                    const taskCount = events.filter(e => e.type === 'task').length;
                    const meetingCount = events.filter(e => e.type === 'meeting').length;
                    const flightCount = events.filter(e => e.category === 'voo').length;
                    const travelCount = events.filter(e => e.category === 'viagem').length;

                    html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">';

                    if (taskCount > 0) {
                        html += `
                            <div style="text-align: center; padding: 15px; background: var(--muted); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${taskCount}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Tarefas</div>
                            </div>
                        `;
                    }

                    if (meetingCount > 0) {
                        html += `
                            <div style="text-align: center; padding: 15px; background: var(--muted); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--warning);">${meetingCount}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Reuniões</div>
                            </div>
                        `;
                    }

                    if (flightCount > 0) {
                        html += `
                            <div style="text-align: center; padding: 15px; background: var(--muted); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--info);">✈️ ${flightCount}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Voos</div>
                            </div>
                        `;
                    }

                    if (travelCount > 0) {
                        html += `
                            <div style="text-align: center; padding: 15px; background: var(--muted); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);">🌍 ${travelCount}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Viagens</div>
                            </div>
                        `;
                    }

                    html += '</div>';

                    // Verificar se há viagem hoje e mostrar info
                    const travelToday = events.find(e => e.category === 'viagem' || e.category === 'voo');
                    if (travelToday && travelToday.location) {
                        updateTravelInfo(travelToday.location, date.toLocaleDateString('pt-BR'));
                    }
                }

                summaryElement.innerHTML = html;
            }
        }

        // Função para inicializar data/hora e calendário
        function initializeDateTimeAndCalendar() {
            console.log('Inicializando data/hora e calendário...');

            try {
                // Iniciar atualização de data e hora
                updateSystemDateTime();
                setInterval(updateSystemDateTime, 1000);

                // Renderizar mini calendário
                renderMiniCalendar();

                console.log('Data/hora e calendário inicializados com sucesso!');
            } catch (error) {
                console.error('Erro ao inicializar data/hora e calendário:', error);
            }
        }

        // Chamar imediatamente se o DOM já estiver carregado
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(initializeDateTimeAndCalendar, 100);
        }

        // Fallback adicional com window.onload
        window.addEventListener('load', function() {
            // Verificar se já foi inicializado
            const dateElement = document.getElementById('current-date');
            if (dateElement && dateElement.textContent === 'Carregando...') {
                console.log('Inicializando via window.load...');
                initializeDateTimeAndCalendar();
            }

            // Inicializar Dashboard de 60 dias (padrão)
            setTimeout(function() {
                if (typeof loadDashboard60Days === 'function') {
                    loadDashboard60Days();
                }
            }, 1000);
        });
        // projectTasks já foi declarado acima
        let tempProjectTasks = [];
        const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        
        // Sistema de Viagens e Voos
        let travelData = {
            currentLocation: 'Brasil',
            trips: []
        };

        // Dados de países para requisitos de viagem
        const countryData = {
            'EUA': {
                flag: '🇺🇸',
                visa: 'Visto B1/B2 necessário',
                vaccines: 'COVID-19 recomendada',
                currency: 'Dólar (USD)',
                rate: 1,
                language: 'Inglês',
                phrases: [
                    { original: 'Hello', translation: 'Olá' },
                    { original: 'Please', translation: 'Por favor' },
                    { original: 'Thank you', translation: 'Obrigado' },
                    { original: 'Where is...?', translation: 'Onde fica...?' }
                ]
            },
            'França': {
                flag: '🇫🇷',
                visa: 'Não necessário (90 dias)',
                vaccines: 'Nenhuma obrigatória',
                currency: 'Euro (EUR)',
                rate: 5.5,
                language: 'Francês',
                phrases: [
                    { original: 'Bonjour', translation: 'Olá' },
                    { original: "S'il vous plaît", translation: 'Por favor' },
                    { original: 'Merci', translation: 'Obrigado' },
                    { original: 'Où est...?', translation: 'Onde fica...?' }
                ]
            },
            'Japão': {
                flag: '🇯🇵',
                visa: 'Não necessário (90 dias)',
                vaccines: 'Nenhuma obrigatória',
                currency: 'Iene (JPY)',
                rate: 0.034,
                language: 'Japonês',
                phrases: [
                    { original: 'こんにちは', translation: 'Olá (Konnichiwa)' },
                    { original: 'お願いします', translation: 'Por favor (Onegaishimasu)' },
                    { original: 'ありがとう', translation: 'Obrigado (Arigatou)' },
                    { original: '...はどこですか？', translation: 'Onde fica...? (... wa doko desu ka?)' }
                ]
            }
        };

        function updateTravelInfo(country, date) {
            const info = countryData[country];
            if (!info) return;

            const travelSection = document.getElementById('travel-info-section');
            if (travelSection) {
                travelSection.style.display = 'block';

                document.getElementById('country-flag').textContent = info.flag;
                document.getElementById('location-name').textContent = country;
                document.getElementById('location-date').textContent = `Viagem em ${date}`;
                document.getElementById('visa-status').textContent = info.visa;
                document.getElementById('vaccine-status').textContent = info.vaccines;
                document.getElementById('currency-name').textContent = info.currency;
                document.getElementById('exchange-rate').textContent = info.rate;
                document.getElementById('language-name').textContent = info.language;

                const phrasesContainer = document.getElementById('useful-phrases');
                phrasesContainer.innerHTML = info.phrases.map(p => `
                    <div class="phrase-item">
                        <span class="phrase-original">${p.original}</span>
                        <span class="phrase-translation">${p.translation}</span>
                    </div>
                `).join('');
            }
        }

        // Funções utilitárias
        function logMessage(message) {
            console.log(message);
        }

        // Funções para gerenciamento de tarefas do projeto
        function addProjectTask() {
            const titleInput = document.getElementById('project-task-title');
            const typeInput = document.getElementById('project-task-type');
            const statusInput = document.getElementById('project-task-status');
            const dateInput = document.getElementById('project-task-date');
            const dependsInput = document.getElementById('project-task-depends');
            const noteInput = document.getElementById('project-task-note');
            
            if (!titleInput.value.trim()) {
                console.log('Por favor, preencha o título da tarefa');
                return;
            }

            const newTask = {
                id: Date.now(),
                title: titleInput.value.trim(),
                tipo: typeInput.value,
                status: statusInput.value,
                due_date: dateInput.value || null,
                depende_de: dependsInput.value || null,
                nota_rapida: noteInput.value.trim() || null,
                data_conclusao: null,
                projectId: null, // Será definido quando o projeto for criado
                completed: statusInput.value === 'Concluída'
            };

            tempProjectTasks.push(newTask);
            
            // Limpar formulário
            titleInput.value = '';
            typeInput.selectedIndex = 0;
            statusInput.selectedIndex = 0;
            dateInput.value = '';
            dependsInput.value = '';
            noteInput.value = '';
            
            renderTempProjectTasks();
            updateDependencyOptions(); // Atualizar as opções de dependência
        }

        function renderTempProjectTasks() {
            const tasksList = document.getElementById('project-tasks-list');
            if (!tasksList) return;

            if (tempProjectTasks.length === 0) {
                tasksList.innerHTML = '<p style="color: #666; font-size: 0.9rem; text-align: center; margin: 10px 0;">Nenhuma tarefa adicionada ainda</p>';
                return;
            }

            tasksList.innerHTML = tempProjectTasks.map((task, index) => {
                const today = new Date();
                const dueDate = task.due_date ? new Date(task.due_date) : null;
                const isOverdue = dueDate && dueDate < today && task.status !== 'Concluída';
                
                // Encontrar tarefa de dependência
                const dependentTask = task.depende_de ? tempProjectTasks.find(t => t.id == task.depende_de) : null;
                const canStart = !task.depende_de || (dependentTask && dependentTask.status === 'Concluída');
                
                // Ícones por tipo
                const typeIcon = {
                    'tarefa': '📋',
                    'marco': '📍',
                    'repetitiva': '🔁'
                }[task.tipo] || '📋';
                
                // Ícones por status
                const statusIcon = {
                    'A fazer': '📝',
                    'Fazendo': '⚡',
                    'Bloqueada': '🚫',
                    'Concluída': '✅',
                    'Adiada': '⏸️'
                }[task.status] || '📝';
                
                return `
                    <div class="project-task-item ${task.status === 'Concluída' ? 'completed' : ''} ${isOverdue ? 'overdue' : ''} ${task.status === 'Bloqueada' || !canStart ? 'blocked' : ''}">
                        <div class="task-main-info">
                            <div class="task-title-line">
                                <span class="task-type-icon">${typeIcon}</span>
                                <span class="task-title">${task.title}</span>
                                <span class="task-status-badge ${task.status.toLowerCase().replace(' ', '-')}">${statusIcon} ${task.status}</span>
                            </div>
                            ${task.due_date ? `<span class="project-task-date">Due: ${formatDate(task.due_date)}</span>` : ''}
                            ${task.depende_de ? `<span class="dependency-info">Depende de: ${dependentTask ? dependentTask.title : 'Tarefa não encontrada'}</span>` : ''}
                            ${task.nota_rapida ? `<span class="task-note">📝 ${task.nota_rapida}</span>` : ''}
                            ${!canStart && task.status !== 'Bloqueada' ? '<span class="blocked-indicator">🔒 Aguardando dependência</span>' : ''}
                        </div>
                        <div class="project-task-actions">
                            <button class="btn-tiny btn-status" onclick="toggleTempTaskStatus(${index})" ${!canStart && task.status !== 'Concluída' && task.status !== 'Bloqueada' ? 'disabled' : ''}>
                                ${task.status === 'Concluída' ? '↶ Reativar' : task.status === 'Fazendo' ? '✓ Concluir' : '▶ Iniciar'}
                            </button>
                            <button class="btn-tiny btn-remove" onclick="removeTempProjectTask(${index})">🗑 Remover</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTempTaskStatus(index) {
            const task = tempProjectTasks[index];
            
            // Ciclo de status: A fazer -> Fazendo -> Concluída -> A fazer
            switch (task.status) {
                case 'A fazer':
                    task.status = 'Fazendo';
                    break;
                case 'Fazendo':
                    task.status = 'Concluída';
                    task.data_conclusao = new Date().toISOString().split('T')[0];
                    break;
                case 'Concluída':
                    task.status = 'A fazer';
                    task.data_conclusao = null;
                    break;
                case 'Bloqueada':
                case 'Adiada':
                    task.status = 'A fazer';
                    task.data_conclusao = null;
                    break;
                default:
                    task.status = 'A fazer';
                    break;
            }
            
            // Manter compatibilidade com campo completed
            task.completed = task.status === 'Concluída';
            
            renderTempProjectTasks();
        }

        function removeTempProjectTask(index) {
            tempProjectTasks.splice(index, 1);
            renderTempProjectTasks();
        }

        function clearTempProjectTasks() {
            tempProjectTasks = [];
            renderTempProjectTasks();
        }

        function updateDependencyOptions() {
            const dependsSelect = document.getElementById('project-task-depends');
            if (!dependsSelect) return;
            
            // Limpar opções existentes exceto a primeira
            dependsSelect.innerHTML = '<option value="">Sem dependência</option>';
            
            // Adicionar tarefas como opções
            tempProjectTasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.title;
                dependsSelect.appendChild(option);
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Fórmula principal: % do projeto = tarefas concluídas ÷ tarefas totais × 100
        function calculateProjectProgress(projectId) {
            const projectTasksList = projectTasks.filter(task => task.projectId === projectId);
            return progressoPorContagem(projectTasksList);
        }

        // Pseudocódigo obrigatório implementado
        function progressoPorContagem(tasksList) {
            if (!tasksList || tasksList.length === 0) return 0.0;
            
            // Expandir tarefas recorrentes como instâncias por período
            const expandedTasks = expandRecurrentTasks(tasksList);
            const total = expandedTasks.length;
            const concluidas = expandedTasks.filter(task => task.status === 'Concluída').length;
            
            if (total <= 0) return 0.0;
            return Math.round(100.0 * concluidas / total * 10) / 10; // 1 decimal
        }

        function expandRecurrentTasks(tasksList) {
            const expanded = [];
            const hoje = new Date();
            
            tasksList.forEach(task => {
                if (task.tipo === 'repetitiva') {
                    // Transformar recorrentes em instâncias semanais (7 dias)
                    for (let i = 0; i < 7; i++) {
                        expanded.push({
                            ...task,
                            id: `${task.id}_day_${i}`,
                            instanceDate: new Date(hoje.getTime() + i * 24 * 60 * 60 * 1000)
                        });
                    }
                } else {
                    expanded.push(task);
                }
            });
            
            return expanded;
        }

        function velocidadeDiaria(projectId) {
            const projectTasksList = projectTasks.filter(task => task.projectId === projectId);
            const ultimos14Dias = new Date();
            ultimos14Dias.setDate(ultimos14Dias.getDate() - 14);
            
            const fechadasUltimos14 = projectTasksList.filter(task => {
                if (!task.data_conclusao) return false;
                const dataConclusao = new Date(task.data_conclusao);
                return dataConclusao >= ultimos14Dias && task.status === 'Concluída';
            }).length;
            
            return fechadasUltimos14 / 14.0;
        }

        function previsaoConclusao(projectId) {
            const projectTasksList = projectTasks.filter(task => task.projectId === projectId);
            const expandedTasks = expandRecurrentTasks(projectTasksList);
            const total = expandedTasks.length;
            const concluidas = expandedTasks.filter(task => task.status === 'Concluída').length;
            const velDiaria = velocidadeDiaria(projectId);
            const hoje = new Date();
            
            // Buscar deadline do projeto
            const project = projects.find(p => p.id === projectId);
            const fimPlanejado = project ? new Date(project.deadline) : new Date();
            
            const restantes = Math.max(total - concluidas, 0);
            if (velDiaria <= 0) return null;
            
            const dias = Math.ceil(restantes / velDiaria);
            const dataPrev = new Date(hoje.getTime() + dias * 24 * 60 * 60 * 1000);
            const desvio = Math.floor((dataPrev - fimPlanejado) / (24 * 60 * 60 * 1000));
            
            return { dataPrev, desvio, diasRestantes: dias };
        }

        function getProjectMetrics(projectId) {
            const projectTasksList = projectTasks.filter(task => task.projectId === projectId);
            const expandedTasks = expandRecurrentTasks(projectTasksList);
            const project = projects.find(p => p.id === projectId);
            
            // Métricas básicas
            const total = expandedTasks.length;
            const concluidas = expandedTasks.filter(task => task.status === 'Concluída').length;
            const restantes = total - concluidas;
            const adiadas = projectTasksList.filter(task => task.status === 'Adiada').length;
            const bloqueadas = projectTasksList.filter(task => task.status === 'Bloqueada').length;
            const marcos = projectTasksList.filter(task => task.tipo === 'marco');
            const marcosConcluidos = marcos.filter(task => task.status === 'Concluída').length;
            
            // Velocidade e previsões
            const velDiaria = velocidadeDiaria(projectId);
            const velSemanal = velDiaria * 7;
            const previsao = previsaoConclusao(projectId);
            
            // Status RAG
            let statusRAG = 'green';
            if (previsao && previsao.desvio > 7) statusRAG = 'red';
            else if (previsao && previsao.desvio > 0) statusRAG = 'yellow';
            if (bloqueadas > 0) statusRAG = 'red'; // Bloqueadas sempre vermelho
            if (progressoPorContagem(expandedTasks) >= 90) statusRAG = 'green';
            
            return {
                // Fórmula principal
                percentual: progressoPorContagem(expandedTasks),
                
                // Contadores
                total,
                concluidas,
                restantes,
                adiadas,
                bloqueadas,
                marcos: marcos.length,
                marcosConcluidos,
                
                // Velocidade
                velocidadeDiaria: velDiaria,
                velocidadeSemanal: velSemanal,
                
                // Previsões
                eta: previsao ? previsao.diasRestantes : null,
                previsaoConclusao: previsao ? previsao.dataPrev : null,
                desvio: previsao ? previsao.desvio : null,
                
                // Status
                statusRAG,
                
                // Meta semanal (placeholder)
                metaSemanal: {
                    meta: 7, // tarefas por semana
                    real: concluidas // simplificado
                }
            };
        }

        // Alertas automáticos
        function checkProjectAlerts(projectId) {
            const projectTasksList = projectTasks.filter(task => task.projectId === projectId);
            const project = projects.find(p => p.id === projectId);
            const metrics = getProjectMetrics(projectId);
            const alerts = [];
            
            // Alerta 1: Escopo expandindo > 20% em 7 dias
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentTasks = projectTasksList.filter(task => {
                const createdDate = new Date(task.id); // Assumindo que ID é timestamp
                return createdDate >= sevenDaysAgo;
            });
            const expansionRate = projectTasksList.length > 0 ? (recentTasks.length / projectTasksList.length) * 100 : 0;
            
            if (expansionRate > 20) {
                alerts.push({
                    type: 'scope-expansion',
                    message: `+escopo: ${expansionRate.toFixed(1)}% de novas tarefas em 7 dias`,
                    severity: 'warning'
                });
            }
            
            // Alerta 2: Estagnação (% parado há 3 dias com tarefas em andamento)
            const fazendoTasks = projectTasksList.filter(task => task.status === 'Fazendo');
            const tresDiasAtras = new Date();
            tresDiasAtras.setDate(tresDiasAtras.getDate() - 3);
            
            if (fazendoTasks.length > 0) {
                const recentCompletions = projectTasksList.filter(task => {
                    if (!task.data_conclusao) return false;
                    const completionDate = new Date(task.data_conclusao);
                    return completionDate >= tresDiasAtras && task.status === 'Concluída';
                });
                
                if (recentCompletions.length === 0) {
                    alerts.push({
                        type: 'stagnation',
                        message: 'Estagnação: Nenhuma conclusão em 3 dias com tarefas em andamento',
                        severity: 'error'
                    });
                }
            }
            
            // Alerta 3: Bloqueadas > 72h
            const bloqueadas = projectTasksList.filter(task => task.status === 'Bloqueada');
            bloqueadas.forEach(task => {
                const blockDate = task.blocked_since || new Date(task.id);
                const hoursBlocked = (new Date() - blockDate) / (1000 * 60 * 60);
                if (hoursBlocked > 72) {
                    alerts.push({
                        type: 'blocked-task',
                        message: `Tarefa bloqueada há ${Math.floor(hoursBlocked)}h: ${task.title}`,
                        severity: 'error'
                    });
                }
            });
            
            // Alerta 4: Previsão ultrapassou prazo final
            if (metrics.desvio && metrics.desvio > 0) {
                alerts.push({
                    type: 'deadline-exceeded',
                    message: `Previsão ultrapassou prazo em ${metrics.desvio} dias`,
                    severity: 'error'
                });
            }
            
            return alerts;
        }

        // Interface compacta para métricas
        function generateProjectDashboard(projectId) {
            const metrics = getProjectMetrics(projectId);
            const alerts = checkProjectAlerts(projectId);
            const project = projects.find(p => p.id === projectId);
            
            // Sparkline simples (últimos 14 dias)
            const sparklineData = [];
            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayCompletions = projectTasks.filter(task => {
                    if (!task.data_conclusao) return false;
                    const completionDate = new Date(task.data_conclusao);
                    return completionDate.toDateString() === date.toDateString() && task.projectId === projectId;
                }).length;
                sparklineData.push(dayCompletions);
            }
            
            const maxCompletions = Math.max(...sparklineData, 1);
            const sparklineHtml = sparklineData.map(value => {
                const height = (value / maxCompletions) * 100;
                return `<div class="sparkline-bar" style="height: ${height}%; background: ${metrics.statusRAG === 'green' ? '#6bcf7f' : metrics.statusRAG === 'yellow' ? '#ffd93d' : '#ff6b6b'}; width: 6px; margin: 0 1px; display: inline-block; vertical-align: bottom;"></div>`;
            }).join('');
            
            return `
                <div class="project-dashboard" style="border-left: 4px solid ${metrics.statusRAG === 'green' ? '#6bcf7f' : metrics.statusRAG === 'yellow' ? '#ffd93d' : '#ff6b6b'};">
                    <!-- Barra principal: % por contagem -->
                    <div class="main-progress-bar" style="background: #f0f0f0; height: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <div style="background: ${metrics.statusRAG === 'green' ? '#6bcf7f' : metrics.statusRAG === 'yellow' ? '#ffd93d' : '#ff6b6b'}; height: 100%; width: ${metrics.percentual}%; border-radius: 4px;"></div>
                    </div>
                    
                    <!-- Barra secundária: progresso da meta semanal -->
                    <div class="weekly-progress" style="background: #e8e8e8; height: 4px; border-radius: 2px; margin-bottom: 12px;">
                        <div style="background: #4ecdc4; height: 100%; width: ${Math.min((metrics.metaSemanal.real / metrics.metaSemanal.meta) * 100, 100)}%; border-radius: 2px;"></div>
                    </div>
                    
                    <!-- Mini cards -->
                    <div class="metrics-cards" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                        <div class="metric-card" style="background: #f8f9fa; padding: 6px 8px; border-radius: 4px; font-size: 11px; min-width: 60px;">
                            <strong>${metrics.total}</strong><br><span style="color: #666;">Total</span>
                        </div>
                        <div class="metric-card" style="background: #f8f9fa; padding: 6px 8px; border-radius: 4px; font-size: 11px; min-width: 60px;">
                            <strong>${metrics.concluidas}</strong><br><span style="color: #666;">Concluídas</span>
                        </div>
                        <div class="metric-card" style="background: #f8f9fa; padding: 6px 8px; border-radius: 4px; font-size: 11px; min-width: 60px;">
                            <strong>${metrics.restantes}</strong><br><span style="color: #666;">Restantes</span>
                        </div>
                        <div class="metric-card" style="background: #f8f9fa; padding: 6px 8px; border-radius: 4px; font-size: 11px; min-width: 70px;">
                            <strong>${metrics.velocidadeSemanal.toFixed(1)}</strong><br><span style="color: #666;">Vel (7d)</span>
                        </div>
                        <div class="metric-card" style="background: #f8f9fa; padding: 6px 8px; border-radius: 4px; font-size: 11px; min-width: 50px;">
                            <strong>${metrics.eta || '∞'}</strong><br><span style="color: #666;">ETA</span>
                        </div>
                        <div class="metric-card" style="background: #f8f9fa; padding: 6px 8px; border-radius: 4px; font-size: 11px; min-width: 60px;">
                            <strong>${metrics.marcosConcluidos}/${metrics.marcos}</strong><br><span style="color: #666;">Marcos</span>
                        </div>
                        ${metrics.adiadas > 0 ? `<div class="metric-card" style="background: #fff3cd; padding: 6px 8px; border-radius: 4px; font-size: 11px; min-width: 60px;">
                            <strong>${metrics.adiadas}</strong><br><span style="color: #856404;">Adiadas</span>
                        </div>` : ''}
                    </div>
                    
                    <!-- Sparkline de velocidade -->
                    <div class="sparkline-container" style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Velocidade (14 dias)</div>
                        <div class="sparkline" style="height: 20px; display: flex; align-items: end;">
                            ${sparklineHtml}
                        </div>
                    </div>
                    
                    <!-- Burnup simples -->
                    <div class="burnup-mini" style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Burnup: Concluídas vs Total</div>
                        <div style="display: flex; gap: 4px; height: 3px;">
                            <div style="background: #6bcf7f; width: ${(metrics.concluidas / metrics.total) * 100}%; height: 100%; border-radius: 2px;"></div>
                            <div style="background: #e8e8e8; flex: 1; height: 100%; border-radius: 2px;"></div>
                        </div>
                    </div>
                    
                    <!-- Alertas -->
                    ${alerts.length > 0 ? `<div class="alerts-container">
                        ${alerts.map(alert => `
                            <div class="alert alert-${alert.severity}" style="background: ${alert.severity === 'error' ? '#ffebee' : '#fff3cd'}; border-left: 3px solid ${alert.severity === 'error' ? '#f44336' : '#ff9800'}; padding: 6px 8px; margin-bottom: 4px; font-size: 11px; border-radius: 0 3px 3px 0;">
                                <strong>${alert.type === 'scope-expansion' ? '📈' : alert.type === 'stagnation' ? '⏸️' : alert.type === 'blocked-task' ? '🚫' : '⚠️'}</strong> ${alert.message}
                            </div>
                        `).join('')}
                    </div>` : ''}
                </div>
            `;
        }

        function getOverdueTasks(projectId) {
            const today = new Date();
            return projectTasks.filter(task => 
                task.projectId === projectId && 
                task.status !== 'Concluída' && 
                !task.completed && 
                new Date(task.deadline || task.due_date) < today
            );
        }
        
        // Função para mostrar views
        function showView(viewName) {
            console.log('Showing view:', viewName);
            
            // Esconder todas as views
            [dashboardView, tasksView, projectsView, reportsView].forEach(view => {
                if (view) view.classList.remove('active');
            });
            
            // Mostrar view selecionada
            const viewMap = {
                'dashboard': dashboardView,
                'tasks': tasksView,
                'projects': projectsView,
                'reports': reportsView
            };
            
            if (viewMap[viewName]) {
                viewMap[viewName].classList.add('active');
            }
            
            logMessage(`View ${viewName} ativada`);
        }
        
        function setActiveButton(activeBtn) {
            [btnDashboard, btnTasks, btnProjects].forEach(btn => {
                if (btn) btn.classList.remove('active');
            });
            if (activeBtn) activeBtn.classList.add('active');
        }
        
        // API Functions
        async function loadTasks() {
            try {
                console.log('Loading tasks from API...');
                
                const response = await fetch(`${API_URL}/tasks`);
                if (response.ok) {
                    const data = await response.json();
                    tasks = data || [];
                    console.log(`API conectada - ${tasks.length} tarefas carregadas`);
                    renderTasks();
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('API Error:', error);
                return false;
            }
        }

        async function loadMeetingsFromAPI() {
            try {
                console.log('Loading meetings from API...');

                const response = await fetch(`${API_URL}/meetings`);
                if (response.ok) {
                    const data = await response.json();
                    meetings = data || [];
                    console.log(`API conectada - ${meetings.length} compromissos carregados`);
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('API Error:', error);
                return false;
            }
        }

        async function createTask(taskData) {
            try {
                console.log('Criando tarefa...');
                const response = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });
                
                if (response.ok) {
                    const newTask = await response.json();
                    tasks.push(newTask);
                    console.log(`Tarefa criada: ${newTask.title}`);
                    renderTasks();
                    return newTask;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Create Task Error:', error);
                console.log(`Erro ao criar tarefa: ${error.message}`);
                return null;
            }
        }
        
        // Project API Functions
        async function loadProjects() {
            try {
                console.log('Loading projects from API...');
                
                const response = await fetch(`${API_URL}/projects`);
                if (response.ok) {
                    const data = await response.json();
                    projects = data || [];
                    console.log(`${projects.length} projetos carregados`);
                    renderProjects();
                    renderHomeProjects();
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('API Error:', error);
                return false;
            }
        }

        async function loadProjectTasks() {
            try {
                console.log('Loading project tasks from API...');
                
                const response = await fetch(`${API_URL}/project-tasks`);
                if (response.ok) {
                    const data = await response.json();
                    projectTasks = data || [];
                    console.log(`${projectTasks.length} project tasks loaded`);
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Project tasks API Error:', error);
                return false;
            }
        }
        
        async function createProject(projectData) {
            try {
                console.log('Criando projeto...');
                const response = await fetch(`${API_URL}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });
                
                if (response.ok) {
                    const newProject = await response.json();
                    projects.push(newProject);
                    console.log(`Projeto criado: ${newProject.title}`);
                    renderProjects();
                    renderHomeProjects();
                    return newProject;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Create Project Error:', error);
                console.log(`Erro ao criar projeto: ${error.message}`);
                return null;
            }
        }
        
        // Render Functions
        function renderTasks() {
            console.log('Rendering tasks:', tasks);
            
            // Recent tasks (últimas 3)
            if (recentTasks) {
                const recent = tasks.slice(-3).reverse();
                recentTasks.innerHTML = recent.length > 0 ?
                    recent.map(task => `
                        <div class="task-item">
                            <div class="task-info">
                                <h3>${task.title}</h3>
                                <p>${task.date} ${task.time} - ${task.priority}</p>
                            </div>
                        </div>
                    `).join('') :
                    '<p>Nenhuma tarefa ainda</p>';
            }
            
            // All tasks
            if (allTasks) {
                allTasks.innerHTML = tasks.length > 0 ?
                    tasks.map(task => `
                        <div class="task-item">
                            <div class="task-info">
                                <h3>${task.title}</h3>
                                <p>${task.description || 'Sem descrição'}</p>
                                <p>${task.date} ${task.time} - Prioridade: ${task.priority}</p>
                            </div>
                            <div class="task-actions">
                                <button class="task-btn complete-btn" onclick="completeTask(${task.id})">Concluir</button>
                                <button class="task-btn delete-btn" onclick="deleteTask(${task.id})">Excluir</button>
                            </div>
                        </div>
                    `).join('') :
                    '<p>Nenhuma tarefa ainda</p>';
            }
        }
        
        function renderProjects() {
            console.log('Rendering projects:', projects);
            
            if (allProjects) {
                allProjects.innerHTML = projects.length > 0 ?
                    projects.map(project => {
                        // Calcular progresso baseado em tarefas
                        const progress = calculateProjectProgress(project.id);
                        const overdueTasks = getOverdueTasks(project.id);
                        const projectTasksList = projectTasks.filter(task => task.projectId === project.id);
                        const completedTasks = projectTasksList.filter(task => task.status === 'Concluída' || task.completed).length;
                        const totalTasks = projectTasksList.length;
                        const milestones = projectTasksList.filter(task => task.milestone || task.tipo === 'marco');
                        const completedMilestones = milestones.filter(task => task.status === 'Concluída' || task.completed).length;
                        
                        // Determinar status dinâmico baseado em deadline e progresso
                        const deadline = new Date(project.deadline);
                        const today = new Date();
                        const daysToDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                        let dynamicStatus = project.status;
                        
                        if (project.status === 'active' && daysToDeadline <= 3 && progress < 80) {
                            dynamicStatus = 'at-risk';
                        } else if (project.status === 'active' && daysToDeadline < 0) {
                            dynamicStatus = 'delayed';
                        }
                        
                        const statusColors = {
                            'planning': '#ffd93d',
                            'active': '#4ecdc4',
                            'paused': '#ff6b6b',
                            'completed': '#6bcf7f',
                            'at-risk': '#ff9f43',
                            'delayed': '#e74c3c'
                        };
                        const statusColor = statusColors[dynamicStatus] || '#4ecdc4';
                        
                        const priorityIcons = {
                            'high': '🔴',
                            'medium': '🟡', 
                            'low': '🟢'
                        };
                        const priorityIcon = priorityIcons[project.priority] || '🟡';
                        
                        const statusLabels = {
                            'planning': 'Planejamento',
                            'active': 'Ativo',
                            'paused': 'Pausado',
                            'completed': 'Concluído',
                            'at-risk': 'Em Risco',
                            'delayed': 'Atrasado'
                        };
                        
                        return `
                            <div class="task-item project-item" style="border-left-color: ${statusColor}; cursor: pointer;" onclick="editProject(${project.id})">
                                <div class="task-info">
                                    <h3>${priorityIcon} ${project.title}</h3>
                                    <p>${project.description || 'Sem descrição'}</p>
                                    <p><strong>Início:</strong> ${project.startDate} | <strong>Deadline:</strong> ${project.deadline} ${daysToDeadline >= 0 ? `(${daysToDeadline} dias)` : `(${Math.abs(daysToDeadline)} dias atrasado)`}</p>
                                    <p><strong>Status:</strong> ${statusLabels[dynamicStatus]} | <strong>Prioridade:</strong> ${project.priority.toUpperCase()}</p>
                                    
                                    <!-- Indicadores de progresso -->
                                    <div class="project-indicators">
                                        <div class="progress-section">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${progress}%; background: ${statusColor};"></div>
                                            </div>
                                            <span>${progress}%</span>
                                        </div>
                                        
                                        <!-- Burndown simples -->
                                        <div class="burndown-section">
                                            <span class="burndown-label">📊 Burndown:</span>
                                            <span class="completed-tasks">${completedTasks}/${totalTasks} tarefas</span>
                                            ${overdueTasks.length > 0 ? `<span class="overdue-indicator">${overdueTasks.length} atrasada${overdueTasks.length > 1 ? 's' : ''}</span>` : ''}
                                        </div>
                                        
                                        <!-- Marcos -->
                                        ${milestones.length > 0 ? `
                                            <div class="milestones-section">
                                                <span class="milestones-label">📍 Marcos:</span>
                                                <span class="milestones-count">${completedMilestones}/${milestones.length}</span>
                                                ${milestones.slice(0, 3).map(m => `<span class="milestone ${m.completed ? 'completed' : 'pending'}" title="${m.title}">${m.completed ? '✅' : '⏳'}</span>`).join('')}
                                                ${milestones.length > 3 ? '...' : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="task-actions" onclick="event.stopPropagation()">
                                    <button class="task-btn complete-btn" onclick="updateProjectProgress(${project.id})">Atualizar</button>
                                    <button class="task-btn delete-btn" onclick="deleteProject(${project.id})">Excluir</button>
                                </div>
                            </div>
                        `;
                    }).join('') :
                    '<p>Nenhum projeto ainda</p>';
            }
            
            // Recent projects (últimos 3 projetos ativos)
            if (recentProjects) {
                const activeProjects = projects.filter(project => project.status === 'active' || project.status === 'planning');
                const recent = activeProjects.slice(-3).reverse();
                recentProjects.innerHTML = recent.length > 0 ?
                    recent.map(project => {
                        const progress = project.progress || 0;
                        const statusColors = {
                            'planning': '#ffd93d',
                            'active': '#4ecdc4',
                            'paused': '#ff6b6b',
                            'completed': '#6bcf7f'
                        };
                        const statusColor = statusColors[project.status] || '#4ecdc4';
                        
                        return `
                            <div class="task-item" style="border-left-color: ${statusColor}; margin-bottom: 10px;">
                                <div class="task-info">
                                    <h3>${project.title}</h3>
                                    <p><strong>Deadline:</strong> ${project.deadline} | <strong>Status:</strong> ${project.status}</p>
                                    <div style="background: #f0f0f0; border-radius: 5px; height: 8px; margin-top: 5px;">
                                        <div style="background: ${statusColor}; height: 100%; border-radius: 5px; width: ${progress}%;"></div>
                                    </div>
                                    <small>${progress}% concluído</small>
                                </div>
                            </div>
                        `;
                    }).join('') :
                    '<p>Nenhum projeto ativo</p>';
            }
        }
        
        function renderHomeProjects() {
            if (!homeProjects) return;
            
            // Filtrar apenas projetos ativos para a home page
            const activeProjects = projects.filter(project => 
                project.status === 'active' || project.status === 'planning'
            );
            
            if (activeProjects.length === 0) {
                homeProjects.innerHTML = '<p>Nenhum projeto ativo</p>';
                return;
            }
            
            homeProjects.innerHTML = activeProjects.slice(0, 5).map(project => {
                // Calcular progresso baseado em tarefas
                const progress = calculateProjectProgress(project.id);
                const overdueTasks = getOverdueTasks(project.id);
                const projectTasksList = projectTasks.filter(task => task.projectId === project.id);
                const completedTasks = projectTasksList.filter(task => task.status === 'Concluída' || task.completed).length;
                const totalTasks = projectTasksList.length;
                
                // Determinar status dinâmico baseado em deadline e progresso
                const deadline = new Date(project.deadline);
                const today = new Date();
                const daysToDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                let dynamicStatus = project.status;
                
                if (project.status === 'active' && daysToDeadline <= 3 && progress < 80) {
                    dynamicStatus = 'at-risk';
                } else if (project.status === 'active' && daysToDeadline < 0) {
                    dynamicStatus = 'delayed';
                }
                
                const statusColors = {
                    'planning': '#ffd93d',
                    'active': '#4ecdc4',
                    'paused': '#ff6b6b',
                    'completed': '#6bcf7f',
                    'at-risk': '#ff9f43',
                    'delayed': '#e74c3c'
                };
                const statusColor = statusColors[dynamicStatus] || '#4ecdc4';
                
                const priorityIcons = {
                    'high': '🔴',
                    'medium': '🟡',
                    'low': '🟢'
                };
                const priorityIcon = priorityIcons[project.priority] || '🟡';
                
                return `
                    <div class="task-item project-item" style="border-left-color: ${statusColor}; cursor: pointer;" onclick="editProject(${project.id})">
                        <div class="task-info">
                            <h4>${priorityIcon} ${project.title}</h4>
                            <p>${project.description ? project.description.substring(0, 60) + '...' : 'Sem descrição'}</p>
                            <p><strong>Deadline:</strong> ${project.deadline} ${daysToDeadline >= 0 ? `(${daysToDeadline} dias)` : `(${Math.abs(daysToDeadline)} dias atrasado)`}</p>
                            
                            <div class="progress-section">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%; background: ${statusColor};"></div>
                                </div>
                                <span>${progress}% • ${completedTasks}/${totalTasks} tarefas</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Calendar functions (mesmo do step 2)
        function updateMonthDisplay() {
            if (currentMonth) {
                currentMonth.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            }
        }
        
        function renderCalendar() {
            if (!calendarGrid) return;
            
            console.log('Rendering calendar for:', currentDate);
            
            // Limpar dias existentes (manter cabeçalhos)
            const headers = calendarGrid.querySelectorAll('.calendar-header');
            calendarGrid.innerHTML = '';
            headers.forEach(header => calendarGrid.appendChild(header));
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();
            
            // Primeiro dia do mês e último dia
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Dias da semana que começam (0 = domingo)
            const startDay = firstDay.getDay();
            
            // Adicionar dias do mês anterior
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const dayElement = createDayElement(prevMonthLastDay - i, true, false);
                calendarGrid.appendChild(dayElement);
            }
            
            // Adicionar dias do mês atual
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = (year === today.getFullYear() && 
                               month === today.getMonth() && 
                               day === today.getDate());
                const dayElement = createDayElement(day, false, isToday);
                calendarGrid.appendChild(dayElement);
            }
            
            // Adicionar dias do próximo mês para completar a grade
            const totalCells = calendarGrid.children.length - 7; // Subtrair cabeçalhos
            const remainingCells = 42 - totalCells; // 6 semanas * 7 dias = 42
            for (let day = 1; day <= remainingCells; day++) {
                const dayElement = createDayElement(day, true, false);
                calendarGrid.appendChild(dayElement);
            }
        }
        
        function createDayElement(day, isOtherMonth, isToday) {
            const dayElement = document.createElement('div');
            dayElement.classList.add('calendar-day');
            dayElement.textContent = day;
            
            if (isOtherMonth) {
                dayElement.classList.add('other-month');
            }
            
            if (isToday) {
                dayElement.classList.add('today');
            }
            
            // Verificar se tem tarefas ou compromissos neste dia
            if (!isOtherMonth) {
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasRegularTasks = tasks.some(task => task.date === dateStr);
                const hasProjectTasks = projectTasks.some(task => task.date === dateStr);
                const hasMeetings = meetings.some(meeting => meeting.date === dateStr);
                if (hasRegularTasks || hasProjectTasks || hasMeetings) {
                    dayElement.classList.add('has-tasks');

                    // Adicionar indicador visual diferente para compromissos
                    if (hasMeetings) {
                        dayElement.classList.add('has-meetings');
                    }
                }
            }
            
            // Event listener para clique no dia
            dayElement.addEventListener('click', function() {
                const dateStr = isOtherMonth ? 
                    `${day} (outro mês)` : 
                    `${day}/${currentDate.getMonth() + 1}/${currentDate.getFullYear()}`;
                    
                console.log('Day clicked:', dateStr);
                
                // Remover seleção anterior
                calendarGrid.querySelectorAll('.calendar-day.selected').forEach(el => {
                    el.classList.remove('selected');
                    el.style.background = '';
                });
                
                // Adicionar seleção atual
                if (!isOtherMonth) {
                    dayElement.classList.add('selected');
                    dayElement.style.background = '#4ecdc4';
                    dayElement.style.color = 'white';
                }
            });
            
            return dayElement;
        }
        
        // Event Listeners
        if (btnDashboard) {
            btnDashboard.addEventListener('click', function() {
                console.log('Dashboard clicked');
                showView('dashboard');
                setActiveButton(btnDashboard);
            });
        }
        
        if (btnTasks) {
            btnTasks.addEventListener('click', function() {
                console.log('Tasks clicked');
                showView('tasks');
                setActiveButton(btnTasks);
            });
        }
        
        if (btnProjects) {
            btnProjects.addEventListener('click', function() {
                console.log('Projects clicked');
                showView('projects');
                setActiveButton(btnProjects);
            });
        }

        if (btnReports) {
            btnReports.addEventListener('click', function() {
                console.log('Reports clicked');
                showView('reports');
                setActiveButton(btnReports);
            });
        }

        // Event listener para botão de adicionar tarefa ao projeto
        const addProjectTaskBtn = document.getElementById('add-project-task');
        if (addProjectTaskBtn) {
            addProjectTaskBtn.addEventListener('click', addProjectTask);
        }
        
        // Função para configurar navegação do calendário
        function setupCalendarNavigation() {
            if (prevMonth) {
                prevMonth.addEventListener('click', function() {
                    console.log('Previous month clicked');
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    updateMonthDisplay();
                    renderCalendar();
                    console.log('Mês anterior: ' + months[currentDate.getMonth()]);
                });
            }

            if (nextMonth) {
                nextMonth.addEventListener('click', function() {
                    console.log('Next month clicked');
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    updateMonthDisplay();
                    renderCalendar();
                    console.log('Próximo mês: ' + months[currentDate.getMonth()]);
                });
            }
        }

        // Configurar navegação quando elementos estiverem disponíveis
        if (prevMonth && nextMonth) {
            setupCalendarNavigation();
        }
        
        // Task form submission
        if (taskForm) {
            taskForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Task form submitted');
                
                const taskData = {
                    title: document.getElementById('task-title').value,
                    description: document.getElementById('task-description').value,
                    date: document.getElementById('task-date').value,
                    time: document.getElementById('task-time').value,
                    priority: document.getElementById('task-priority').value,
                    category: document.getElementById('task-category').value,
                    completed: false,
                    reminder: false
                };
                
                const newTask = await createTask(taskData);
                if (newTask) {
                    taskForm.reset();
                    console.log(`Tarefa "${newTask.title}" criada com sucesso!`);
                    renderCalendar(); // Re-render para mostrar indicadores
                }
            });
        }
        
        // Funções globais para botões das tarefas
        window.completeTask = async function(taskId) {
            try {
                const task = tasks.find(t => t.id === taskId);
                if (!task) {
                    console.log('Tarefa não encontrada');
                    return;
                }
                
                const updatedTask = { ...task, completed: !task.completed };
                
                const response = await fetch(`${API_URL}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedTask)
                });
                
                if (response.ok) {
                    const index = tasks.findIndex(t => t.id === taskId);
                    tasks[index] = updatedTask;
                    console.log(`Tarefa ${updatedTask.completed ? 'concluída' : 'reativada'}: ${task.title}`);
                    renderTasks();
                } else {
                    console.log('Erro ao atualizar tarefa');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                console.log('Erro ao completar tarefa');
            }
        };
        
        window.deleteTask = async function(taskId) {
            try {
                const task = tasks.find(t => t.id === taskId);
                if (!task) {
                    console.log('Tarefa não encontrada');
                    return;
                }
                
                if (confirm(`Tem certeza que deseja excluir a tarefa "${task.title}"?`)) {
                    const response = await fetch(`${API_URL}/tasks/${taskId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        tasks = tasks.filter(t => t.id !== taskId);
                        console.log(`Tarefa excluída: ${task.title}`);
                        renderTasks();
                    } else {
                        console.log('Erro ao excluir tarefa');
                    }
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                console.log('Erro ao excluir tarefa');
            }
        };
        
        // Project form submission
        if (projectForm) {
            projectForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Project form submitted');
                
                const projectData = {
                    title: document.getElementById('project-title').value,
                    description: document.getElementById('project-description').value,
                    startDate: document.getElementById('project-start-date').value,
                    deadline: document.getElementById('project-deadline').value,
                    priority: document.getElementById('project-priority').value,
                    status: document.getElementById('project-status').value,
                    startReal: document.getElementById('project-start-real').value || null,
                    endReal: null,
                    nextAction: document.getElementById('project-next-action').value || '',
                    tags: document.getElementById('project-tags').value || '',
                    velocity: 0,
                    eta: null,
                    rag: 'verde',
                    progress: 0
                };
                
                const newProject = await createProject(projectData);
                if (newProject) {
                    // Salvar tarefas do projeto
                    if (tempProjectTasks.length > 0) {
                        const projectTasksData = tempProjectTasks.map(task => ({
                            ...task,
                            projectId: newProject.id
                        }));
                        
                        // Salvar as tarefas do projeto
                        try {
                            const response = await fetch(`${API_URL}/project-tasks`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(projectTasksData)
                            });
                            
                            if (response.ok) {
                                projectTasks.push(...projectTasksData);
                                console.log(`${tempProjectTasks.length} tarefas adicionadas ao projeto`);
                            }
                        } catch (error) {
                            console.error('Erro ao salvar tarefas do projeto:', error);
                        }
                    }
                    
                    // Limpar formulário e tarefas temporárias
                    projectForm.reset();
                    clearTempProjectTasks();
                    console.log(`Projeto "${newProject.title}" criado com sucesso!`);
                }
            });
        }
        
        // Funções globais para botões dos projetos
        window.updateProjectProgress = async function(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const newProgress = prompt(`Atualizar progresso do projeto "${project.title}"\nProgresso atual: ${project.progress || 0}%\n\nDigite o novo progresso (0-100):`);
            
            if (newProgress !== null && newProgress !== '') {
                const progress = Math.min(100, Math.max(0, parseInt(newProgress)));
                
                try {
                    const response = await fetch(`${API_URL}/projects/${projectId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...project,
                            progress: progress,
                            status: progress === 100 ? 'completed' : project.status
                        })
                    });
                    
                    if (response.ok) {
                        const updatedProject = await response.json();
                        const index = projects.findIndex(p => p.id === projectId);
                        projects[index] = updatedProject;
                        console.log(`Projeto ${projectId} atualizado para ${progress}%`);
                        renderProjects();
                    renderHomeProjects();
                    }
                } catch (error) {
                    console.error('Erro ao atualizar projeto:', error);
                    alert('Erro ao atualizar o progresso do projeto');
                }
            }
        };
        
        window.deleteProject = async function(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (confirm(`Tem certeza que deseja excluir o projeto "${project.title}"?`)) {
                try {
                    const response = await fetch(`${API_URL}/projects/${projectId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        projects = projects.filter(p => p.id !== projectId);
                        console.log(`Projeto ${projectId} excluído`);
                        renderProjects();
                    renderHomeProjects();
                    }
                } catch (error) {
                    console.error('Erro ao excluir projeto:', error);
                    alert('Erro ao excluir o projeto');
                }
            }
        };

        let currentEditingProject = null;
        let currentEditingProjectTasks = [];

        window.editProject = function(projectId) {
            console.log('Tentando editar projeto:', projectId);
            console.log('Projetos disponíveis:', projects);
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                console.log('Projeto não encontrado!');
                return;
            }
            console.log('Projeto encontrado:', project);
            
            currentEditingProject = project;
            
            document.getElementById('edit-project-title').value = project.title;
            document.getElementById('edit-project-description').value = project.description || '';
            document.getElementById('edit-project-start-date').value = project.startDate;
            document.getElementById('edit-project-deadline').value = project.deadline;
            document.getElementById('edit-project-priority').value = project.priority;
            document.getElementById('edit-project-status').value = project.status;
            document.getElementById('edit-project-start-real').value = project.startReal || '';
            document.getElementById('edit-project-end-real').value = project.endReal || '';
            document.getElementById('edit-project-next-action').value = project.nextAction || '';
            document.getElementById('edit-project-tags').value = project.tags || '';
            document.getElementById('edit-project-velocity').value = project.velocity || 0;
            document.getElementById('edit-project-eta').value = project.eta || '';
            
            // Set RAG status
            setRAGStatus('edit-project-rag', project.rag || 'verde');
            
            // Carregar tarefas do projeto
            currentEditingProjectTasks = projectTasks.filter(task => task.projectId === projectId);
            renderEditProjectTasks();
            
            document.getElementById('edit-project-modal').style.display = 'flex';
        };

        window.closeEditProjectModal = function() {
            document.getElementById('edit-project-modal').style.display = 'none';
            currentEditingProject = null;
            currentEditingProjectTasks = [];
        };

        function renderEditProjectTasks() {
            const tasksList = document.getElementById('edit-project-tasks-list');
            if (!tasksList) return;

            if (currentEditingProjectTasks.length === 0) {
                tasksList.innerHTML = '<p style="color: #666; font-size: 0.9rem; text-align: center; margin: 10px 0;">Nenhuma tarefa no projeto ainda</p>';
                return;
            }

            tasksList.innerHTML = currentEditingProjectTasks.map((task, index) => {
                const today = new Date();
                const deadline = new Date(task.date || task.deadline);
                const isOverdue = deadline < today && !task.completed;
                
                return `
                    <div class="project-task-item ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}">
                        <div>
                            <span>${task.title}</span>
                            <span class="project-task-date">${formatDate(task.date || task.deadline)}</span>
                        </div>
                        <div class="project-task-actions">
                            <button class="btn-tiny btn-complete" onclick="toggleEditProjectTaskStatus(${index})">
                                ${task.completed ? 'Reativar' : 'Concluir'}
                            </button>
                            <button class="btn-tiny" onclick="removeEditProjectTask(${index})" style="background: #e63946; color: white;">Remover</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addEditProjectTask() {
            const titleInput = document.getElementById('edit-project-task-title');
            const typeInput = document.getElementById('edit-project-task-type');
            const statusInput = document.getElementById('edit-project-task-status');
            const dateInput = document.getElementById('edit-project-task-date');
            const dependsInput = document.getElementById('edit-project-task-depends');
            const noteInput = document.getElementById('edit-project-task-note');
            
            if (!titleInput.value.trim()) return;
            
            const newTask = {
                id: Date.now(), // Temporary ID for new tasks
                title: titleInput.value.trim(),
                tipo: typeInput.value,
                status: statusInput.value,
                due_date: dateInput.value || null,
                depende_de: dependsInput.value || null,
                nota_rapida: noteInput.value.trim() || null,
                data_conclusao: statusInput.value === 'Concluída' ? new Date().toISOString().split('T')[0] : null,
                projectId: currentEditingProject.id,
                completed: statusInput.value === 'Concluída',
                isNew: true // Flag to identify new tasks
            };
            
            currentEditingProjectTasks.push(newTask);
            titleInput.value = '';
            typeInput.selectedIndex = 0;
            statusInput.selectedIndex = 0;
            dateInput.value = '';
            dependsInput.value = '';
            noteInput.value = '';
            renderEditProjectTasks();
        }

        window.toggleEditProjectTaskStatus = function(index) {
            currentEditingProjectTasks[index].completed = !currentEditingProjectTasks[index].completed;
            renderEditProjectTasks();
        };

        window.removeEditProjectTask = function(index) {
            const task = currentEditingProjectTasks[index];
            if (task.isNew) {
                // For new tasks, just remove from the array
                currentEditingProjectTasks.splice(index, 1);
            } else {
                // For existing tasks, mark for deletion
                currentEditingProjectTasks[index].isDeleted = true;
            }
            renderEditProjectTasks();
        };

        async function updateProject(projectData) {
            try {
                const response = await fetch(`${API_URL}/projects/${currentEditingProject.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(projectData)
                });

                if (response.ok) {
                    const updatedProject = await response.json();
                    const index = projects.findIndex(p => p.id === currentEditingProject.id);
                    if (index !== -1) {
                        projects[index] = updatedProject;
                    }

                    // Update project tasks
                    await updateProjectTasks();

                    renderProjects();
                    renderHomeProjects();
                    renderCalendar();
                    closeEditProjectModal();
                    console.log('Projeto atualizado com sucesso');
                    return updatedProject;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error updating project:', error);
                alert('Erro ao atualizar o projeto');
                return null;
            }
        }

        async function updateProjectTasks() {
            try {
                // Filter out deleted tasks and prepare the tasks for saving
                const validTasks = currentEditingProjectTasks.filter(task => !task.isDeleted);
                
                // Update the global projectTasks array
                projectTasks = projectTasks.filter(task => task.projectId !== currentEditingProject.id);
                projectTasks = projectTasks.concat(validTasks.map(task => ({
                    id: task.id || Date.now() + Math.random(),
                    title: task.title,
                    date: task.date || task.deadline,
                    deadline: task.date || task.deadline,
                    completed: task.completed || false,
                    projectId: currentEditingProject.id
                })));

                // Save to the backend
                const response = await fetch(`${API_URL}/project-tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(projectTasks)
                });

                if (response.ok) {
                    console.log('Project tasks updated successfully');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Error updating project tasks:', error);
                return false;
            }
        }

        // Form submission handlers
        document.addEventListener('DOMContentLoaded', function() {
            const editProjectForm = document.getElementById('edit-project-form');
            if (editProjectForm) {
                editProjectForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!currentEditingProject) return;
                    
                    const projectData = {
                        title: document.getElementById('edit-project-title').value,
                        description: document.getElementById('edit-project-description').value,
                        startDate: document.getElementById('edit-project-start-date').value,
                        deadline: document.getElementById('edit-project-deadline').value,
                        priority: document.getElementById('edit-project-priority').value,
                        status: document.getElementById('edit-project-status').value,
                        startReal: document.getElementById('edit-project-start-real').value || null,
                        endReal: document.getElementById('edit-project-end-real').value || null,
                        nextAction: document.getElementById('edit-project-next-action').value || '',
                        tags: document.getElementById('edit-project-tags').value || '',
                        velocity: parseFloat(document.getElementById('edit-project-velocity').value) || 0,
                        eta: document.getElementById('edit-project-eta').value || null,
                        rag: getSelectedRAG('edit-project-rag')
                    };
                    
                    // Auto-set end date when project is completed
                    if (projectData.status === 'Concluído' && !projectData.endReal) {
                        projectData.endReal = new Date().toISOString().split('T')[0];
                        document.getElementById('edit-project-end-real').value = projectData.endReal;
                    }
                    
                    await updateProject(projectData);
                });
            }

            // Event listener for add project task button in edit modal
            const addEditProjectTaskBtn = document.getElementById('add-edit-project-task');
            if (addEditProjectTaskBtn) {
                addEditProjectTaskBtn.addEventListener('click', addEditProjectTask);
            }
        });

        // RAG Status Helper Functions
        function setRAGStatus(ragContainerId, activeStatus) {
            const container = document.getElementById(ragContainerId);
            if (!container) return;
            
            const indicators = container.querySelectorAll('.rag-indicator');
            indicators.forEach(indicator => {
                indicator.classList.remove('active');
                if (indicator.classList.contains(activeStatus)) {
                    indicator.classList.add('active');
                }
            });
        }

        function getSelectedRAG(ragContainerId) {
            const container = document.getElementById(ragContainerId);
            if (!container) return 'verde';
            
            const activeIndicator = container.querySelector('.rag-indicator.active');
            if (activeIndicator) {
                if (activeIndicator.classList.contains('verde')) return 'verde';
                if (activeIndicator.classList.contains('amarelo')) return 'amarelo';
                if (activeIndicator.classList.contains('vermelho')) return 'vermelho';
            }
            return 'verde';
        }

        // RAG Status click handlers
        function setupRAGClickHandlers() {
            const ragContainers = document.querySelectorAll('.rag-status');
            ragContainers.forEach(container => {
                const indicators = container.querySelectorAll('.rag-indicator');
                indicators.forEach(indicator => {
                    indicator.addEventListener('click', function() {
                        // Remove active from all in this container
                        indicators.forEach(ind => ind.classList.remove('active'));
                        // Add active to clicked one
                        this.classList.add('active');
                        
                        // Calculate and update automatic fields
                        if (container.id === 'edit-project-rag') {
                            calculateProjectMetrics();
                        }
                    });
                });
            });
        }

        // Calculate automatic project metrics
        function calculateProjectMetrics() {
            if (!currentEditingProject) return;

            const projectId = currentEditingProject.id;
            const projectTasksList = projectTasks.filter(task => task.projectId === projectId);
            
            // Calculate velocity (tasks completed per week)
            const completedTasks = projectTasksList.filter(task => task.status === 'Concluída' || task.completed).length;
            const startDate = new Date(currentEditingProject.startReal || currentEditingProject.startDate);
            const now = new Date();
            const weeksElapsed = Math.max(1, Math.ceil((now - startDate) / (1000 * 60 * 60 * 24 * 7)));
            const velocity = completedTasks / weeksElapsed;
            
            document.getElementById('edit-project-velocity').value = velocity.toFixed(2);
            
            // Calculate ETA
            const remainingTasks = projectTasksList.filter(task => task.status !== 'Concluída' && !task.completed).length;
            if (velocity > 0 && remainingTasks > 0) {
                const weeksToComplete = remainingTasks / velocity;
                const etaDate = new Date(now.getTime() + (weeksToComplete * 7 * 24 * 60 * 60 * 1000));
                document.getElementById('edit-project-eta').value = etaDate.toISOString().split('T')[0];
            }

            // Auto-calculate RAG status based on deadline proximity and progress
            const deadline = new Date(currentEditingProject.deadline);
            const daysUntilDeadline = (deadline - now) / (1000 * 60 * 60 * 24);
            const progress = calculateProjectProgress(projectId);
            
            let ragStatus = 'verde';
            if (daysUntilDeadline < 7 && progress < 80) {
                ragStatus = 'vermelho';
            } else if (daysUntilDeadline < 14 && progress < 60) {
                ragStatus = 'amarelo';
            }
            
            // Only auto-set if user hasn't manually set it
            const currentRAG = getSelectedRAG('edit-project-rag');
            if (currentRAG === 'verde') { // Default, likely not manually set
                setRAGStatus('edit-project-rag', ragStatus);
            }
        }

        // Reports Functions
        function generateReport(period) {
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'current-week':
                    startDate = getStartOfWeek(now);
                    endDate = getEndOfWeek(now);
                    break;
                case 'last-week':
                    const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    startDate = getStartOfWeek(lastWeek);
                    endDate = getEndOfWeek(lastWeek);
                    break;
                case 'last-2-weeks':
                    endDate = new Date(now);
                    startDate = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
                    break;
                case 'last-month':
                    endDate = new Date(now);
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    startDate = getStartOfWeek(now);
                    endDate = getEndOfWeek(now);
            }
            
            const reportData = analyzeData(startDate, endDate);
            displayReport(reportData, period);
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getEndOfWeek(date) {
            const startOfWeek = getStartOfWeek(date);
            return new Date(startOfWeek.getTime() + 6 * 24 * 60 * 60 * 1000);
        }

        function analyzeData(startDate, endDate) {
            const activeProjects = projects.filter(p => p.status === 'active' || p.status === 'planning');
            const allProjectTasks = projectTasks;
            const allTasks = tasks;
            
            let totalTasks = 0;
            let completedTasks = 0;
            let projectStats = [];
            
            activeProjects.forEach(project => {
                const projectTasksList = allProjectTasks.filter(task => task.projectId === project.id);
                const projectCompletedTasks = projectTasksList.filter(task => 
                    task.status === 'Concluída' || task.completed
                ).length;
                const projectTotalTasks = projectTasksList.length;
                
                const tasksInPeriod = projectTasksList.filter(task => {
                    const completedDate = task.data_conclusao ? new Date(task.data_conclusao) : null;
                    return completedDate && completedDate >= startDate && completedDate <= endDate;
                });
                
                const progress = calculateProjectProgress(project.id);
                const deadline = new Date(project.deadline);
                const daysToDeadline = Math.ceil((deadline - new Date()) / (1000 * 60 * 60 * 24));
                
                let status = 'success';
                if (daysToDeadline < 7 && progress < 80) status = 'danger';
                else if (daysToDeadline < 14 && progress < 60) status = 'warning';
                
                const taskBreakdown = {
                    tarefa: projectTasksList.filter(t => t.tipo === 'tarefa' || !t.tipo).length,
                    marco: projectTasksList.filter(t => t.tipo === 'marco').length,
                    repetitiva: projectTasksList.filter(t => t.tipo === 'repetitiva').length
                };
                
                projectStats.push({
                    name: project.title,
                    progress: progress,
                    completedTasks: projectCompletedTasks,
                    totalTasks: projectTotalTasks,
                    tasksCompletedInPeriod: tasksInPeriod.length,
                    status: status,
                    deadline: project.deadline,
                    daysToDeadline: daysToDeadline,
                    taskBreakdown: taskBreakdown,
                    velocity: calculateVelocity(project.id, startDate, endDate),
                    overdueTasks: getOverdueTasks(project.id).length
                });
                
                totalTasks += projectTotalTasks;
                completedTasks += projectCompletedTasks;
            });
            
            const personalTasksInPeriod = allTasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate >= startDate && taskDate <= endDate;
            });
            
            const completedPersonalTasks = personalTasksInPeriod.filter(task => task.completed).length;
            
            return {
                period: formatPeriod(startDate, endDate),
                totalProjects: activeProjects.length,
                totalTasks: totalTasks,
                completedTasks: completedTasks,
                completionRate: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0,
                personalTasks: personalTasksInPeriod.length,
                completedPersonalTasks: completedPersonalTasks,
                personalCompletionRate: personalTasksInPeriod.length > 0 ? 
                    Math.round((completedPersonalTasks / personalTasksInPeriod.length) * 100) : 0,
                projects: projectStats.sort((a, b) => b.progress - a.progress),
                overallVelocity: calculateOverallVelocity(startDate, endDate)
            };
        }

        function calculateVelocity(projectId, startDate, endDate) {
            const projectTasksList = projectTasks.filter(task => task.projectId === projectId);
            const completedInPeriod = projectTasksList.filter(task => {
                const completedDate = task.data_conclusao ? new Date(task.data_conclusao) : null;
                return completedDate && completedDate >= startDate && completedDate <= endDate;
            });
            
            const days = (endDate - startDate) / (1000 * 60 * 60 * 24);
            const weeks = Math.max(1, days / 7);
            return Math.round((completedInPeriod.length / weeks) * 10) / 10;
        }

        function calculateOverallVelocity(startDate, endDate) {
            let totalCompleted = 0;
            projects.forEach(project => {
                totalCompleted += calculateVelocity(project.id, startDate, endDate);
            });
            return Math.round(totalCompleted * 10) / 10;
        }

        function formatPeriod(startDate, endDate) {
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return `${startDate.toLocaleDateString('pt-BR', options)} - ${endDate.toLocaleDateString('pt-BR', options)}`;
        }

        function displayReport(data, period) {
            const reportContent = document.getElementById('report-content');
            
            const html = `
                <div class="report-section">
                    <h3>📊 Relatório de Produtividade - ${data.period}</h3>
                    
                    <div class="report-metrics">
                        <div class="metric-card">
                            <div class="metric-value">${data.totalProjects}</div>
                            <div class="metric-label">Projetos Ativos</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${data.completedTasks}/${data.totalTasks}</div>
                            <div class="metric-label">Tarefas do Projeto</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${data.completionRate}%</div>
                            <div class="metric-label">Taxa de Conclusão</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${data.completedPersonalTasks}/${data.personalTasks}</div>
                            <div class="metric-label">Tarefas Pessoais</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${data.overallVelocity}</div>
                            <div class="metric-label">Velocidade Geral</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${data.personalCompletionRate}%</div>
                            <div class="metric-label">Eficiência Pessoal</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>📁 Resumo por Projeto</h3>
                    ${data.projects.map(project => `
                        <div class="project-summary ${project.status}">
                            <h4>${project.name}</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span><strong>Progresso:</strong> ${project.progress}%</span>
                                <span><strong>Deadline:</strong> ${project.daysToDeadline} dias</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><strong>Tarefas:</strong> ${project.completedTasks}/${project.totalTasks}</span>
                                <span><strong>Velocidade:</strong> ${project.velocity} tarefas/semana</span>
                            </div>
                            ${project.overdueTasks > 0 ? `<div style="color: #e74c3c;"><strong>⚠️ ${project.overdueTasks} tarefas em atraso</strong></div>` : ''}
                            <div class="task-breakdown">
                                <div class="task-type-count">📋 ${project.taskBreakdown.tarefa} Tarefas</div>
                                <div class="task-type-count">📍 ${project.taskBreakdown.marco} Marcos</div>
                                <div class="task-type-count">🔁 ${project.taskBreakdown.repetitiva} Repetitivas</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="report-section">
                    <h3>📈 Insights e Recomendações</h3>
                    ${generateInsights(data)}
                </div>

                <div class="export-options">
                    <h4>📊 Opções de Exportação</h4>
                    <p>Use os botões acima para exportar este relatório em diferentes formatos.</p>
                </div>
            `;
            
            reportContent.innerHTML = html;
        }

        function generateInsights(data) {
            const insights = [];
            
            if (data.completionRate < 50) {
                insights.push(`<p>🔴 <strong>Taxa de conclusão baixa (${data.completionRate}%):</strong> Considere revisar o planejamento das tarefas ou redistribuir a carga de trabalho.</p>`);
            } else if (data.completionRate > 80) {
                insights.push(`<p>🟢 <strong>Excelente taxa de conclusão (${data.completionRate}%):</strong> Continue mantendo esse ritmo produtivo!</p>`);
            }
            
            const projectsAtRisk = data.projects.filter(p => p.status === 'danger').length;
            if (projectsAtRisk > 0) {
                insights.push(`<p>⚠️ <strong>${projectsAtRisk} projeto(s) em risco:</strong> Atenção aos prazos próximos com baixo progresso.</p>`);
            }
            
            const highVelocityProjects = data.projects.filter(p => p.velocity > 3).length;
            if (highVelocityProjects > 0) {
                insights.push(`<p>🚀 <strong>${highVelocityProjects} projeto(s) com alta velocidade:</strong> Ótimo ritmo de execução!</p>`);
            }
            
            const overdueTotal = data.projects.reduce((sum, p) => sum + p.overdueTasks, 0);
            if (overdueTotal > 0) {
                insights.push(`<p>📅 <strong>${overdueTotal} tarefas em atraso:</strong> Priorize essas tarefas para evitar impacto nos prazos.</p>`);
            }
            
            if (data.personalCompletionRate > data.completionRate) {
                insights.push(`<p>💼 <strong>Eficiência pessoal superior:</strong> Suas tarefas pessoais têm melhor taxa de conclusão que projetos.</p>`);
            }
            
            return insights.length > 0 ? insights.join('') : '<p>📊 Desempenho equilibrado. Continue assim!</p>';
        }

        function exportReport() {
            const reportContent = document.getElementById('report-content');
            const content = reportContent.innerHTML;
            
            const exportWindow = window.open('', '_blank');
            exportWindow.document.write(`
                <html>
                    <head>
                        <title>Relatório de Produtividade</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .report-section { margin-bottom: 30px; padding: 20px; border-left: 4px solid #3498db; background: #f8f9fa; }
                            .report-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
                            .metric-card { background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                            .metric-value { font-size: 24px; font-weight: bold; color: #2c3e50; }
                            .metric-label { font-size: 12px; color: #666; margin-top: 5px; }
                            .project-summary { background: white; margin: 10px 0; padding: 15px; border-radius: 6px; border-left: 4px solid #27ae60; }
                            .project-summary.warning { border-left-color: #f39c12; }
                            .project-summary.danger { border-left-color: #e74c3c; }
                            .task-breakdown { display: flex; gap: 10px; margin: 10px 0; }
                            .task-type-count { background: #ecf0f1; padding: 8px 12px; border-radius: 4px; font-size: 12px; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        <h1>📈 Relatório de Produtividade</h1>
                        <p><em>Gerado em: ${new Date().toLocaleString('pt-BR')}</em></p>
                        ${content}
                        <hr style="margin-top: 40px;">
                        <p style="text-align: center; color: #666; font-size: 12px;">
                            Sistema de Organização - Relatório Automático
                        </p>
                    </body>
                </html>
            `);
            exportWindow.document.close();
            setTimeout(() => exportWindow.print(), 1000);
        }

        // Função para carregar lista de tarefas na aba Tarefas
        function loadTasksList() {
            const tasksList = document.getElementById('tasks-list');
            if (!tasksList) return;

            const allTasks = [...tasks, ...projectTasks];
            
            // Separar tarefas por status
            const pendingTasks = allTasks.filter(t => t.status !== 'Concluída');
            const completedTasks = allTasks.filter(t => t.status === 'Concluída');
            const overdueTasks = pendingTasks.filter(t => {
                if (!t.date) return false;
                const taskDate = new Date(t.date);
                return taskDate < new Date() && t.status !== 'Concluída';
            });

            tasksList.innerHTML = `
                <div class="tasks-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Resumo</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div>📝 Total: ${allTasks.length}</div>
                        <div>⏳ Pendentes: ${pendingTasks.length}</div>
                        <div>✅ Concluídas: ${completedTasks.length}</div>
                        <div style="color: ${overdueTasks.length > 0 ? '#e74c3c' : '#27ae60'}">⚠️ Atrasadas: ${overdueTasks.length}</div>
                    </div>
                </div>

                <div class="tasks-container">
                    ${allTasks.map(task => {
                        const isOverdue = task.date && new Date(task.date) < new Date() && task.status !== 'Concluída';
                        const project = task.projectId ? projects.find(p => p.id === task.projectId) : null;
                        
                        return `
                            <div class="task-item" style="
                                background: white;
                                padding: 15px;
                                margin: 10px 0;
                                border-radius: 8px;
                                border-left: 4px solid ${task.status === 'Concluída' ? '#27ae60' : isOverdue ? '#e74c3c' : '#3498db'};
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; ${task.status === 'Concluída' ? 'text-decoration: line-through;' : ''}">${task.title}</h4>
                                        ${task.description ? `<p style="margin: 5px 0; color: #666; font-size: 14px;">${task.description}</p>` : ''}
                                        ${project ? `<span style="background: #ecf0f1; padding: 3px 8px; border-radius: 4px; font-size: 12px;">📁 ${project.name}</span>` : ''}
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="background: ${task.status === 'Concluída' ? '#27ae60' : '#f39c12'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px;">${task.status}</span>
                                        ${task.date ? `<div style="margin-top: 5px; font-size: 12px; color: #666;">📅 ${new Date(task.date).toLocaleDateString('pt-BR')}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            // Adicionar filtros de tarefas
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const filter = btn.getAttribute('data-filter');
                    const taskItems = tasksList.querySelectorAll('.task-item');
                    
                    taskItems.forEach(item => {
                        const taskData = allTasks[Array.from(taskItems).indexOf(item)];
                        if (!taskData) return;
                        
                        let show = false;
                        switch(filter) {
                            case 'all':
                                show = true;
                                break;
                            case 'pending':
                                show = taskData.status !== 'Concluída';
                                break;
                            case 'completed':
                                show = taskData.status === 'Concluída';
                                break;
                            case 'overdue':
                                show = taskData.date && new Date(taskData.date) < new Date() && taskData.status !== 'Concluída';
                                break;
                        }
                        item.style.display = show ? 'block' : 'none';
                    });
                });
            });
        }

        // Função para carregar preferências
        function loadPreferences() {
            const savedPrefs = localStorage.getItem('userPreferences');
            if (savedPrefs) {
                const prefs = JSON.parse(savedPrefs);
                
                document.getElementById('pref-notifications').checked = prefs.notifications !== false;
                document.getElementById('pref-dark-mode').checked = prefs.darkMode === true;
                document.getElementById('pref-work-start').value = prefs.workStart || '09:00';
                document.getElementById('pref-work-end').value = prefs.workEnd || '18:00';
                document.getElementById('pref-reminder-interval').value = prefs.reminderInterval || 30;
            }
        }

        // Função para salvar preferências
        window.savePreferences = function() {
            const prefs = {
                notifications: document.getElementById('pref-notifications').checked,
                darkMode: document.getElementById('pref-dark-mode').checked,
                workStart: document.getElementById('pref-work-start').value,
                workEnd: document.getElementById('pref-work-end').value,
                reminderInterval: parseInt(document.getElementById('pref-reminder-interval').value)
            };
            
            localStorage.setItem('userPreferences', JSON.stringify(prefs));
            
            // Aplicar modo escuro se ativado
            if (prefs.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            alert('Preferências salvas com sucesso!');
        }

        // Função atualizada para gerar relatório (compatível com o botão da aba)
        window.generateReport = function() {
            const reportType = document.getElementById('report-type')?.value || 'summary';
            const reportContent = document.getElementById('report-content');
            
            if (!reportContent) return;
            
            // Usar a função generateReport existente
            const period = reportType === 'weekly' ? 'current-week' : 'current-month';
            generateReport(period);
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded - Step 3');
            console.log('Sistema iniciando - Conectando à API...');

            // Inicializar data/hora e mini calendário PRIMEIRO
            initializeDateTimeAndCalendar();

            updateMonthDisplay();
            renderCalendar();
            
            const tasksConnected = await loadTasks();
            const projectsConnected = await loadProjects();
            const projectTasksConnected = await loadProjectTasks();
            const meetingsConnected = await loadMeetingsFromAPI();

            if (tasksConnected && projectsConnected && projectTasksConnected && meetingsConnected) {
                console.log('Sistema pronto - API conectada');
                renderCalendar(); // Re-render com indicadores de tarefa
                renderProjects(); // Re-render projects with complete data
                renderHomeProjects(); // Re-render home projects section
                setupRAGClickHandlers(); // Setup RAG status click handlers
                
                // Setup reports event listeners
                const generateReportBtn = document.getElementById('generate-report');
                const exportReportBtn = document.getElementById('export-report');
                const reportPeriodSelect = document.getElementById('report-period');
                
                if (generateReportBtn) {
                    generateReportBtn.addEventListener('click', function() {
                        const period = reportPeriodSelect ? reportPeriodSelect.value : 'current-week';
                        generateReport(period);
                    });
                }
                
                if (exportReportBtn) {
                    exportReportBtn.addEventListener('click', exportReport);
                }
            } else {
                console.log('API parcialmente conectada ou offline');
            }
        });
        
        console.log('Step 3 script loaded successfully');
    </script>

    <!-- Modal para Tarefa Recorrente -->
    <div id="recurrent-task-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h2>🔄 Nova Tarefa Recorrente</h2>
            
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Título da Tarefa:</label>
                <input type="text" id="recurrent-title" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Descrição:</label>
                <textarea id="recurrent-description" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px;"></textarea>
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Tipo de Recorrência:</label>
                <select id="recurrent-type" onchange="updateRecurrenceOptions()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="daily">Diária</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensal</option>
                    <option value="custom">Personalizada</option>
                </select>
            </div>
            
            <div id="recurrence-options" style="margin: 15px 0;">
                <!-- Options will be dynamically added based on type -->
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Horário:</label>
                <input type="time" id="recurrent-time" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Categoria:</label>
                <select id="recurrent-category" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="pessoal">Pessoal</option>
                    <option value="trabalho">Trabalho</option>
                    <option value="saude">Saúde</option>
                    <option value="financas">Finanças</option>
                    <option value="voo">✈️ Voo</option>
                    <option value="viagem">🌍 Viagem</option>
                </select>
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">Prioridade:</label>
                <select id="recurrent-priority" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="baixa">Baixa</option>
                    <option value="media">Média</option>
                    <option value="alta">Alta</option>
                </select>
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 5px;">
                    <input type="checkbox" id="recurrent-end-date-check" onchange="toggleEndDate()">
                    Definir data de término
                </label>
                <input type="date" id="recurrent-end-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; display: none;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="closeRecurrentModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancelar</button>
                <button onclick="saveRecurrentTask()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">Criar Tarefa Recorrente</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificações Avançadas -->
    <div id="notification-settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px;">
            <h2>🔔 Configurar Notificações</h2>
            
            <div style="margin: 20px 0;">
                <h3>Lembretes Múltiplos</h3>
                <div id="reminder-list" style="margin: 10px 0;">
                    <label style="display: block; margin: 5px 0;">
                        <input type="checkbox" value="0" checked> No horário
                    </label>
                    <label style="display: block; margin: 5px 0;">
                        <input type="checkbox" value="5"> 5 minutos antes
                    </label>
                    <label style="display: block; margin: 5px 0;">
                        <input type="checkbox" value="15"> 15 minutos antes
                    </label>
                    <label style="display: block; margin: 5px 0;">
                        <input type="checkbox" value="30"> 30 minutos antes
                    </label>
                    <label style="display: block; margin: 5px 0;">
                        <input type="checkbox" value="60"> 1 hora antes
                    </label>
                    <label style="display: block; margin: 5px 0;">
                        <input type="checkbox" value="1440"> 1 dia antes
                    </label>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <h3>Som de Notificação</h3>
                <select id="notification-sound" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="default">Padrão</option>
                    <option value="bell">Sino</option>
                    <option value="chime">Carrilhão</option>
                    <option value="alert">Alerta</option>
                    <option value="none">Sem som</option>
                </select>
            </div>
            
            <div style="margin: 20px 0;">
                <label style="display: block; margin: 5px 0;">
                    <input type="checkbox" id="persistent-notifications" checked>
                    Notificações persistentes (requerem ação)
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="closeNotificationSettings()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancelar</button>
                <button onclick="saveNotificationSettings()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Salvar Configurações</button>
            </div>
        </div>
    </div>

    <script>
        // Sistema de Tarefas Recorrentes
        let recurrentTasks = JSON.parse(localStorage.getItem('recurrentTasks') || '[]');
        
        function openRecurrentTaskModal() {
            document.getElementById('recurrent-task-modal').style.display = 'flex';
            updateRecurrenceOptions();
        }
        
        function closeRecurrentModal() {
            document.getElementById('recurrent-task-modal').style.display = 'none';
            document.getElementById('recurrent-title').value = '';
            document.getElementById('recurrent-description').value = '';
        }
        
        function updateRecurrenceOptions() {
            const type = document.getElementById('recurrent-type').value;
            const optionsDiv = document.getElementById('recurrence-options');
            
            switch(type) {
                case 'daily':
                    optionsDiv.innerHTML = `
                        <label style="display: block; margin-bottom: 5px;">Repetir a cada:</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="daily-interval" value="1" min="1" style="width: 60px; padding: 5px;">
                            <span>dia(s)</span>
                        </div>
                    `;
                    break;
                    
                case 'weekly':
                    optionsDiv.innerHTML = `
                        <label style="display: block; margin-bottom: 5px;">Repetir nos dias:</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 5px;">
                            <label><input type="checkbox" value="0"> Dom</label>
                            <label><input type="checkbox" value="1" checked> Seg</label>
                            <label><input type="checkbox" value="2"> Ter</label>
                            <label><input type="checkbox" value="3"> Qua</label>
                            <label><input type="checkbox" value="4"> Qui</label>
                            <label><input type="checkbox" value="5"> Sex</label>
                            <label><input type="checkbox" value="6"> Sáb</label>
                        </div>
                    `;
                    break;
                    
                case 'monthly':
                    optionsDiv.innerHTML = `
                        <label style="display: block; margin-bottom: 5px;">Repetir no dia:</label>
                        <input type="number" id="monthly-day" value="1" min="1" max="31" style="width: 60px; padding: 5px;">
                        <span> de cada mês</span>
                    `;
                    break;
                    
                case 'custom':
                    optionsDiv.innerHTML = `
                        <label style="display: block; margin-bottom: 5px;">Intervalo personalizado (dias):</label>
                        <input type="number" id="custom-interval" value="1" min="1" style="width: 100px; padding: 5px;">
                    `;
                    break;
            }
        }
        
        function toggleEndDate() {
            const checked = document.getElementById('recurrent-end-date-check').checked;
            document.getElementById('recurrent-end-date').style.display = checked ? 'block' : 'none';
        }
        
        function saveRecurrentTask() {
            const task = {
                id: 'rec_' + Date.now(),
                title: document.getElementById('recurrent-title').value,
                description: document.getElementById('recurrent-description').value,
                type: document.getElementById('recurrent-type').value,
                time: document.getElementById('recurrent-time').value,
                category: document.getElementById('recurrent-category').value,
                priority: document.getElementById('recurrent-priority').value,
                isRecurrent: true,
                createdAt: new Date().toISOString()
            };
            
            // Adicionar configurações específicas de recorrência
            const type = task.type;
            if (type === 'daily') {
                task.interval = document.getElementById('daily-interval')?.value || 1;
            } else if (type === 'weekly') {
                const checkedDays = Array.from(document.querySelectorAll('#recurrence-options input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                task.weekDays = checkedDays;
            } else if (type === 'monthly') {
                task.monthDay = document.getElementById('monthly-day')?.value || 1;
            } else if (type === 'custom') {
                task.customInterval = document.getElementById('custom-interval')?.value || 1;
            }
            
            if (document.getElementById('recurrent-end-date-check').checked) {
                task.endDate = document.getElementById('recurrent-end-date').value;
            }
            
            recurrentTasks.push(task);
            localStorage.setItem('recurrentTasks', JSON.stringify(recurrentTasks));
            
            // Gerar instâncias da tarefa recorrente
            generateRecurrentInstances(task);
            
            closeRecurrentModal();
            loadTasksList();
            alert('Tarefa recorrente criada com sucesso!');
        }
        
        function generateRecurrentInstances(recurrentTask) {
            const instances = [];
            const today = new Date();
            const endDate = recurrentTask.endDate ? new Date(recurrentTask.endDate) : new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 dias por padrão
            
            let currentDate = new Date(today);
            
            while (currentDate <= endDate) {
                if (shouldCreateInstance(recurrentTask, currentDate)) {
                    const instance = {
                        id: Date.now() + '_' + Math.random(),
                        title: recurrentTask.title,
                        description: recurrentTask.description,
                        date: currentDate.toISOString().split('T')[0],
                        time: recurrentTask.time,
                        category: recurrentTask.category,
                        priority: recurrentTask.priority,
                        status: 'Pendente',
                        recurrentId: recurrentTask.id,
                        isRecurrentInstance: true
                    };
                    
                    tasks.push(instance);
                }
                
                // Avançar para o próximo dia
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Salvar tarefas atualizadas
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        
        function shouldCreateInstance(task, date) {
            switch(task.type) {
                case 'daily':
                    const interval = parseInt(task.interval) || 1;
                    const daysDiff = Math.floor((date - new Date(task.createdAt)) / (1000 * 60 * 60 * 24));
                    return daysDiff % interval === 0;
                    
                case 'weekly':
                    const weekDay = date.getDay().toString();
                    return task.weekDays && task.weekDays.includes(weekDay);
                    
                case 'monthly':
                    return date.getDate() === parseInt(task.monthDay);
                    
                case 'custom':
                    const customInterval = parseInt(task.customInterval) || 1;
                    const customDaysDiff = Math.floor((date - new Date(task.createdAt)) / (1000 * 60 * 60 * 24));
                    return customDaysDiff % customInterval === 0;
                    
                default:
                    return false;
            }
        }
        
        // Sistema de Busca Avançada
        function searchTasks() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            const priority = document.getElementById('filter-priority').value;
            const dateRange = document.getElementById('filter-date-range').value;
            const recurrentFilter = document.getElementById('filter-recurrent').value;
            
            let filteredTasks = [...tasks, ...projectTasks];
            
            // Filtrar por termo de busca
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => 
                    task.title.toLowerCase().includes(searchTerm) ||
                    (task.description && task.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtrar por categoria
            if (category) {
                filteredTasks = filteredTasks.filter(task => task.category === category);
            }
            
            // Filtrar por prioridade
            if (priority) {
                filteredTasks = filteredTasks.filter(task => task.priority === priority);
            }
            
            // Filtrar por período
            if (dateRange) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                filteredTasks = filteredTasks.filter(task => {
                    if (!task.date) return false;
                    const taskDate = new Date(task.date);
                    
                    switch(dateRange) {
                        case 'today':
                            return taskDate.toDateString() === today.toDateString();
                        case 'week':
                            const weekEnd = new Date(today);
                            weekEnd.setDate(weekEnd.getDate() + 7);
                            return taskDate >= today && taskDate <= weekEnd;
                        case 'month':
                            return taskDate.getMonth() === today.getMonth() && 
                                   taskDate.getFullYear() === today.getFullYear();
                        case 'overdue':
                            return taskDate < today && task.status !== 'Concluída';
                        default:
                            return true;
                    }
                });
            }
            
            // Filtrar por recorrência
            if (recurrentFilter === 'recurrent') {
                filteredTasks = filteredTasks.filter(task => task.isRecurrentInstance);
            } else if (recurrentFilter === 'single') {
                filteredTasks = filteredTasks.filter(task => !task.isRecurrentInstance);
            }
            
            // Exibir resultados
            displaySearchResults(filteredTasks);
        }
        
        function displaySearchResults(filteredTasks) {
            const tasksList = document.getElementById('tasks-list');
            
            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhuma tarefa encontrada com os filtros aplicados.</p>';
                return;
            }
            
            tasksList.innerHTML = `
                <div class="search-results">
                    <p style="margin-bottom: 10px; color: #666;">Encontradas ${filteredTasks.length} tarefa(s)</p>
                    ${filteredTasks.map(task => {
                        const isOverdue = task.date && new Date(task.date) < new Date() && task.status !== 'Concluída';
                        const project = task.projectId ? projects.find(p => p.id === task.projectId) : null;
                        
                        return `
                            <div class="task-item" style="
                                background: white;
                                padding: 15px;
                                margin: 10px 0;
                                border-radius: 8px;
                                border-left: 4px solid ${task.status === 'Concluída' ? '#27ae60' : isOverdue ? '#e74c3c' : '#3498db'};
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; ${task.status === 'Concluída' ? 'text-decoration: line-through;' : ''}">
                                            ${task.isRecurrentInstance ? '🔄 ' : ''}${task.title}
                                        </h4>
                                        ${task.description ? `<p style="margin: 5px 0; color: #666; font-size: 14px;">${task.description}</p>` : ''}
                                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                                            ${project ? `<span style="background: #ecf0f1; padding: 3px 8px; border-radius: 4px; font-size: 12px;">📁 ${project.name}</span>` : ''}
                                            ${task.category ? `<span style="background: #e8f5e9; padding: 3px 8px; border-radius: 4px; font-size: 12px;">${task.category}</span>` : ''}
                                            ${task.priority ? `<span style="background: ${task.priority === 'alta' ? '#ffebee' : task.priority === 'media' ? '#fff3e0' : '#f3f4f6'}; padding: 3px 8px; border-radius: 4px; font-size: 12px;">${task.priority}</span>` : ''}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="background: ${task.status === 'Concluída' ? '#27ae60' : '#f39c12'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px;">${task.status}</span>
                                        ${task.date ? `<div style="margin-top: 5px; font-size: 12px; color: #666;">📅 ${new Date(task.date).toLocaleDateString('pt-BR')}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function toggleAdvancedFilters() {
            const filtersDiv = document.getElementById('advanced-filters');
            filtersDiv.style.display = filtersDiv.style.display === 'none' ? 'block' : 'none';
        }
        
        // Sistema de Notificações Avançadas
        let notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{"reminders": [0, 5], "sound": "default", "persistent": true}');
        
        function setupAdvancedNotifications() {
            // Verificar tarefas periodicamente
            setInterval(() => {
                checkUpcomingTasks();
            }, 30000); // Verificar a cada 30 segundos
        }
        
        function checkUpcomingTasks() {
            const now = new Date();
            const allTasks = [...tasks, ...projectTasks];
            
            allTasks.forEach(task => {
                if (task.date && task.time && task.status !== 'Concluída') {
                    const taskDateTime = new Date(`${task.date}T${task.time}`);
                    
                    notificationSettings.reminders.forEach(minutesBefore => {
                        const notifyTime = new Date(taskDateTime.getTime() - minutesBefore * 60000);
                        
                        if (now >= notifyTime && now < new Date(notifyTime.getTime() + 30000)) {
                            showAdvancedNotification(task, minutesBefore);
                        }
                    });
                }
            });
        }
        
        function showAdvancedNotification(task, minutesBefore) {
            const notificationKey = `notified_${task.id}_${minutesBefore}`;
            
            // Evitar notificações duplicadas
            if (localStorage.getItem(notificationKey)) {
                return;
            }
            
            let title = task.title;
            let body = '';
            
            if (minutesBefore === 0) {
                body = 'A tarefa deve ser iniciada agora!';
            } else if (minutesBefore < 60) {
                body = `Faltam ${minutesBefore} minutos para a tarefa`;
            } else if (minutesBefore === 60) {
                body = 'Falta 1 hora para a tarefa';
            } else if (minutesBefore === 1440) {
                body = 'Esta tarefa está agendada para amanhã';
            }
            
            // Criar notificação
            if (Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: '/icon.png',
                    requireInteraction: notificationSettings.persistent,
                    tag: task.id
                });
                
                // Tocar som se configurado
                if (notificationSettings.sound !== 'none') {
                    playNotificationSound(notificationSettings.sound);
                }
                
                notification.onclick = () => {
                    window.focus();
                    // Navegar para a tarefa
                    notification.close();
                };
                
                // Marcar como notificado
                localStorage.setItem(notificationKey, 'true');
                
                // Limpar flag após 24 horas
                setTimeout(() => {
                    localStorage.removeItem(notificationKey);
                }, 24 * 60 * 60 * 1000);
            }
        }
        
        function playNotificationSound(soundType) {
            // Criar elemento de áudio para tocar o som
            const audio = new Audio();
            
            switch(soundType) {
                case 'bell':
                    audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBz2Gy/DaiToHE2i98OScTgwLUKzn77BdGQc0getm';
                    break;
                case 'chime':
                    audio.src = 'data:audio/wav;base64,UklGRvIFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQkFAAD/////////////////////////////////////////////////////////////////////';
                    break;
                case 'alert':
                    audio.src = 'data:audio/wav;base64,UklGRrQEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQkEAAAAAAD//////////////////////////////////////////////////////////////////////////////////////////';
                    break;
                default:
                    audio.src = 'data:audio/wav;base64,UklGRl4FAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YToFAAAAAAAAAAAAAAAAAAD/////////////////////////////////////////////////////////////////////';
            }
            
            audio.play().catch(e => console.log('Erro ao tocar som:', e));
        }
        
        function openNotificationSettings() {
            document.getElementById('notification-settings-modal').style.display = 'flex';
            
            // Carregar configurações atuais
            const reminderList = document.getElementById('reminder-list');
            reminderList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = notificationSettings.reminders.includes(parseInt(cb.value));
            });
            
            document.getElementById('notification-sound').value = notificationSettings.sound;
            document.getElementById('persistent-notifications').checked = notificationSettings.persistent;
        }
        
        function closeNotificationSettings() {
            document.getElementById('notification-settings-modal').style.display = 'none';
        }
        
        function saveNotificationSettings() {
            const reminders = Array.from(document.querySelectorAll('#reminder-list input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.value));
            
            notificationSettings = {
                reminders: reminders,
                sound: document.getElementById('notification-sound').value,
                persistent: document.getElementById('persistent-notifications').checked
            };
            
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            closeNotificationSettings();
            alert('Configurações de notificação salvas!');
        }
        
        // Inicializar sistema de notificações avançadas
        document.addEventListener('DOMContentLoaded', () => {
            setupAdvancedNotifications();
            
            // Solicitar permissão para notificações se necessário
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
        
        // Atualizar a função loadTasksList para incluir tarefas recorrentes
        const originalLoadTasksList = loadTasksList;
        loadTasksList = function() {
            originalLoadTasksList();
            
            // Adicionar botão de configurações de notificação
            const tasksContainer = document.querySelector('#tasks-list');
            if (tasksContainer && !document.getElementById('notification-settings-btn')) {
                const settingsBtn = document.createElement('button');
                settingsBtn.id = 'notification-settings-btn';
                settingsBtn.innerHTML = '🔔 Configurar Notificações';
                settingsBtn.style = 'position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
                settingsBtn.onclick = openNotificationSettings;
                document.body.appendChild(settingsBtn);
            }
        };
    </script>
</body>
</html>
